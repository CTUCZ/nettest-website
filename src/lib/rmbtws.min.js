/*!******************************************************************************
 * @license
 * Copyright 2015-2017 Thomas Schreiber
 * Copyright 2017      Rundfunk und Telekom Regulierungs-GmbH (RTR-GmbH)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The source code for this project is available at
 * https://github.com/rtr-nettest/rmbtws
 *****************************************************************************!*/
"use strict";var RMBTTest=function(){function e(e){S=e,_=TestState.INIT}function t(e){void 0!==_&&_===e||(_=e,h=performance.now())}function n(e,n,r){var i=(e.test_server_encryption?"wss://":"ws://")+e.test_server_address+":"+e.test_server_port;N(i);var u=function(){return{IGNORE:function(){},CALLGLOBALHANDLER:function(){D(RMBTError.CONNECT_FAILED)},TRYRECONNECT:function(){D(RMBTError.CONNECT_FAILED)}}}();n.onStateEnter(TestState.INIT_DOWN,function(){t(TestState.INIT_DOWN),N(n.id+": start short download"),g=m,0===n.id?o(n,S.pretestDurationMs):n.triggerNextState()}),n.onStateEnter(TestState.PING,function(){t(TestState.PING),N(n.id+": starting ping"),0===n.id?a(n):n.triggerNextState()}),n.onStateEnter(TestState.DOWN,function(){t(TestState.DOWN),n.id<B?d(n,e.test_duration):n.triggerNextState()}),n.onStateEnter(TestState.INIT_UP,function(){t(TestState.INIT_UP),g=m,0===n.id?c(n,S.pretestDurationMs):n.triggerNextState()}),n.onStateEnter(TestState.UP,function(){t(TestState.UP),n.id<C?l(n,e.test_duration):(n.socket.onerror=u.IGNORE,n.socket.readyState!==WebSocket.CLOSED&&n.socket.close(),n.triggerNextState())}),n.onStateEnter(TestState.END,function(){n.socket.readyState!==WebSocket.CLOSED&&n.socket.close(),0===n.id&&r()}),n.setState(TestState.INIT),t(TestState.INIT),s(n,i,e.test_token,u.CALLGLOBALHANDLER)}function s(e,t,n,s){try{e.socket=new WebSocket(t)}catch(e){return void D(RMBTError.SOCKET_INIT_FAILED)}e.socket.binaryType="arraybuffer",e.socket.onerror=s,e.socket.onmessage=function(t){if(0===t.data.indexOf("CHUNKSIZE")){var o=t.data.trim().split(" ");4===o.length?(v=parseInt(o[1]),m=parseInt(o[2]),E=parseInt(o[3])):(v=parseInt(o[1]),m=v),N(e.id+"Chunksizes: min "+m+", max: "+E+", default: "+v)}else if(0===t.data.indexOf("RMBTv")){var r=t.data.substring(5).trim();S.client_version=r,0===r.indexOf("1.")?b=!0:0===r.indexOf("0.3")?b=!1:N("unknown server version: "+r)}else"ACCEPT TOKEN QUIT\n"===t.data?e.socket.send("TOKEN "+n+"\n"):"OK\n"===t.data&&e.state===TestState.INIT?N(e.id+": Token accepted"):"ERR\n"===t.data?(s(),N("got error msg")):0===t.data.indexOf("ACCEPT GETCHUNKS")&&e.triggerNextState()}}function o(e,t){var n=e.socket.onmessage,s=performance.now(),o=1,a=0;!function i(){r(e,o,function(r){a+=o*g,N(e.id+": "+r);var d=parseInt(r.substring(5));if(performance.now()-s>t){w=o*g/(d/1e9),N(e.id+": circa "+w/1e3+" KB/sec"),N(e.id+": circa "+8*w/1e6+" MBit/sec");var c=8*w/1e6;Object.keys(S.downloadThreadsLimitsMbit).forEach(function(e){c>e&&(B=S.downloadThreadsLimitsMbit[e])}),B=Math.min(k,B),N(e.id+": set number of threads to be used in download speed test to: "+B);var u=w/(1e3/(S.measurementPointsTimespan/2));u-=u%1024,u=Math.max(m,u),u=Math.min(E,u),N(e.id+": calculated chunksize for download speed test "+u/1024+" KB"),g=u,e.socket.onmessage=n}else o<8||!b?(o*=2,i()):(g=Math.min(2*g,E),i())})}()}function r(e,t,n){var s=e.socket,o=t,r=g*t,a=0,i=function(e){"string"!=typeof e.data&&(a+=e.data.byteLength,e.data.byteLength!==g&&1!==e.data.byteLength||o--,0===o?(s.onmessage=function(e){var t=e.data;n(t)},s.send("OK\n"),U[g]=e.data):(L.hasOwnProperty(g)||(L[g]=[]),L[g].length<S.savedChunks&&L[g].push(e.data)))};s.onmessage=i,N(e.id+": downloading "+t+" chunks, "+r/1e3+" KB");var d="GETCHUNKS "+t+(g!==v?" "+g:"")+"\n";s.send(d)}function a(e){var t=1/0,n=e.socket.onmessage,s=S.numPings;i(e,function o(r){if(s--,e.result.pings.push(r),r.client<t&&(t=r.client),N(e.id+": PING "+r.client+" ns client; "+r.server+" ns server"),s>0)e.socket.onmessage=function(t){"ACCEPT GETCHUNKS GETTIME PUT PUTNORESULT PING QUIT\n"===t.data?i(e,o):N("unexpected error during ping test")};else{for(var a=[],d=0;d<e.result.pings.length;d++)a.push(e.result.pings[d].client);y.ping_median=Math.median(a),N(e.id+": shortest: "+Math.round(t/1e3)/1e3+" ms"),y.ping_shortest=t,e.socket.onmessage=n}})}function i(e,t){var n,s,o=function(o){if("PONG\n"===o.data){var r=nowNs();s=r-n,e.socket.send("OK\n")}else if(0===o.data.indexOf("TIME")){var a=new RMBTPingResult;a.client=s,a.server=parseInt(o.data.substring(5)),a.timeNs=n,t(a)}};e.socket.onmessage=o,n=nowNs(),e.socket.send("PING\n")}function d(e,t){var n,s,o=e.socket.onmessage,r=0,a=0,i=-1,d=null,c=null;n=window.setInterval(function(){if(null!==d&&i!==a){i=a;var t=nowNs();N(e.id+": "+s+"|"+S.measurementPointsTimespan+"|"+t+"|"+a);var u=new Uint8Array(d,d.byteLength-1,1),p=c-l;e.result.down.push({duration:p,bytes:r}),s=t,u[0]>=255&&(N(e.id+": received end chunk"),window.clearInterval(n),e.socket.onmessage=function(t){N(t.data),e.socket.onmessage=o},e.socket.send("OK\n"))}},S.measurementPointsTimespan);var u=function(e){a++,r+=e.data.byteLength,c=nowNs(),d=e.data};e.socket.onmessage=u;var l=nowNs();e.socket.send("GETTIME "+t+(g!==v?" "+g:"")+"\n")}function c(e,t){var n=e.socket.onmessage,s=performance.now(),o=1,r=0;window.setTimeout(function(){var e=performance.now(),n=e-s;N("diff:"+(n-t)+" ("+(n-t)/t+" %)")},t);!function a(){u(e,o,function(i){if(r+=o*g,N(e.id+": "+i),performance.now()-s>t){e.socket.onmessage=n;var d=parseInt(i.substring(5));w=o*g/(d/1e9),N(e.id+": circa "+w/1e3+" KB/sec up"),N(e.id+": circa "+8*w/1e6+" MBit/sec up");var c=8*w/1e6;Object.keys(S.uploadThreadsLimitsMbit).forEach(function(e){c>e&&(C=S.uploadThreadsLimitsMbit[e])}),C=Math.min(k,C),N(e.id+": set number of threads to be used in upload speed test to: "+C);var u=w/(1e3/(S.measurementPointsTimespan/2));u-=u%1024,u=Math.max(v,u),u=Math.min(E,u);var l=Number.POSITIVE_INFINITY;Object.keys(L).forEach(function(e){Math.abs(u-e)<Math.abs(u-l)?l=e:(delete L[e],delete U[e])}),N(e.id+": calculated chunksize for upload speed test "+u/1024+" KB"),N(e.id+": used chunk size for upload speed test will be: "+l/1024+" KB"),g=l}else{var p=2*g;o<8||!U.hasOwnProperty(p)||!b?(o*=2,a()):(g=Math.min(2*g,E),a())}})}()}function u(e,t,n){var s=e.socket;s.onmessage=function(e){0!==e.data.indexOf("OK")&&0!==e.data.indexOf("ACCEPT")&&n(e.data)},N(e.id+": uploading "+t+" chunks, "+g*t/1e3+" KB"),s.send("PUTNORESULT"+(b?" "+g:"")+"\n");for(var o=0;o<t;o++){var r;r=o===t-1?U[g]:L[g][0],s.send(r)}}function l(e,t){var n=e.socket.onmessage,s=w/2/C,o=Math.ceil(w/C/g),r=!1,a=!0,i=-1,d=0,c=function s(){r||(N(e.id+": is 7.2 sec in, got data for "+i),i<1e9*t&&d<3e3?(window.setTimeout(s,250),d+=250):(N(e.id+": didn't finish, timeout extended by "+d+" ms, last info for "+i),e.socket.onerror=function(){},e.socket.close(),e.socket.onmessage=n,N(e.id+": socket now closed: "+e.socket.readyState),e.triggerNextState()))},u=function t(){if(e.socket.bufferedAmount<s)for(var n=0;n<o;n++)e.socket.send(L[g][n%L[g].length]);if(!a)return!1;setTimeout(t,0)};window.setTimeout(c,1e3*t+200),window.setTimeout(function(){a=!1,e.socket.send(U[g]),e.socket.send("QUIT\n")},1e3*t),N(e.id+": set timeout");var l=/TIME (\d+) BYTES (\d+)/,p=/TIME (\d+)/,f=function(t){"OK\n"===t.data&&u();var s=l.exec(t.data);if(null!==s){var o={duration:parseInt(s[1]),bytes:parseInt(s[2])};i=o.duration,e.result.up.push(o)}else null!==(s=p.exec(t.data))&&(r=!0,N("Upload duration: "+s[1]),e.socket.onmessage=n)};e.socket.onmessage=f,e.socket.send("PUT"+(g!==v?" "+g:"")+"\n")}function p(e,t){var n={version:e.version,language:e.language,uuid:e.uuid,type:e.type,version_code:e.version_code,client:e.client,timezone:e.timezone,time:(new Date).getTime()};"undefined"!=typeof userServerSelection&&userServerSelection>0&&"undefined"!=typeof UserConf&&void 0!==UserConf.preferredServer&&"default"!==UserConf.preferredServer&&(n.prefer_server=UserConf.preferredServer,n.user_server_selection=userServerSelection),$.ajax({url:e.controlServerURL+e.controlServerRegistrationResource,type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(n),success:function(e){var n=new RMBTControlServerRegistrationResponse(e);t(n)},error:function(){N("error getting testID")}})}function f(e){$.ajax({url:e.controlServerURL+e.controlServerDataCollectorResource,type:"get",dataType:"json",contentType:"application/json",success:function(t){e.product=t.agent.substring(0,Math.min(150,t.agent.length)),e.model=t.product,e.os_version=t.version},error:function(){N("error getting data collection response")}})}function T(e,t){var n={client_language:"de",client_name:S.client,client_uuid:S.uuid,client_version:S.client_version,client_software_version:S.client_software_version,geoLocations:y.geoLocations,model:S.model,network_type:98,platform:S.platform,product:S.product,pings:y.pings,test_bytes_download:y.bytes_download,test_bytes_upload:y.bytes_upload,test_nsec_download:y.nsec_download,test_nsec_upload:y.nsec_upload,test_num_threads:B,num_threads_ul:C,test_ping_shortest:y.ping_shortest,test_speed_download:y.speed_download,test_speed_upload:y.speed_upload,test_token:e.test_token,time:y.beginTime,timezone:"Europe/Vienna",type:"DESKTOP",version_code:"1",speed_detail:y.speedItems,user_server_selection:S.userServerSelection},s=JSON.stringify(n);N("Submit size: "+s.length),$.ajax({url:S.controlServerURL+S.controlServerResultResource,type:"post",dataType:"json",contentType:"application/json",data:s,success:function(n){N("https://develop.netztest.at/en/Verlauf?"+e.test_uuid),t()},error:function(){N("error submitting results")}})}var g,m,v,S,_,h,I,k,w,N=function(e){$("#debug").prepend(e+"\n"),console.log(e)},E=4194304,b=!1,y=null,M=null,O={durationInitMs:2500,durationPingMs:500,durationUpMs:-1,durationDownMs:-1},R=new RMBTIntermediateResult,P=new Array,L={},U={},B=0,C=0;e.prototype.onError=function(e){M=e};var D=function(e){if(!e===RMBTError.NOT_SUPPORTED&&t(TestState.ERROR),null!==M){var n=M;M=null,n()}};return e.prototype.startTest=function(){if(void 0===window.WebSocket)return void D(RMBTError.NOT_SUPPORTED);t(TestState.INIT),y=new RMBTTestResult,f(S),p(S,function(e){k=parseInt(e.test_numthreads),I=new CyclicBarrier(k),O.durationDownMs=1e3*e.test_duration,O.durationUpMs=1e3*e.test_duration,null!==TestEnvironment.getTestVisualization()&&TestEnvironment.getTestVisualization().updateInfo(e.test_server_name,e.client_remote_ip,e.provider,e.test_uuid);var s,o=function(){N("got geolocation, obtaining token and websocket address"),t(TestState.WAIT),window.setTimeout(function(){t(TestState.INIT),y.beginTime=Date().now;for(var o=0;o<k;o++){var r=new RMBTTestThread(I);r.id=o,y.addThread(r.result),n(e,r,function(){N("All tests finished"),s.stop(),y.geoLocations=s.getResults(),y.calculateAll(),T(e,function(){t(TestState.END)})}),P.push(r)}},1e3*e.test_wait)};null!==TestEnvironment.getGeoTracker()?(s=TestEnvironment.getGeoTracker(),o()):(s=new GeoTracker,N("getting geolocation"),s.start(function(){o()}))})},e.prototype.getIntermediateResult=function(){R.status=_;var e=performance.now()-h;switch(R.status){case TestState.WAIT:R.progress=0;break;case TestState.INIT:case TestState.WAIT:case TestState.INIT_DOWN:case TestState.INIT_UP:R.progress=e/O.durationInitMs;break;case TestState.PING:R.progress=e/O.durationPingMs;break;case TestState.DOWN:R.progress=e/O.durationDownMs;break;case TestState.UP:R.progress=e/O.durationUpMs;break;case TestState.END:R.progress=1;break;case TestState.ERROR:case TestState.ABORTED:R.progress=0}if(isNaN(R.progress)&&(R.progress=0),R.progress=Math.min(1,R.progress),null!==y){if(R.pingNano=y.ping_median,R.status===TestState.DOWN){for(var t=0,n=1/0,s=0;s<P.length>0;s++){var o=y.threads[s].down;o.length>0&&(t+=o[o.length-1].bytes,o[o.length-1].duration<n&&(n=o[o.length-1].duration))}R.downBitPerSec=Math.max(0,8*t/(n/1e9)),R.downBitPerSecLog=(log10(R.downBitPerSec/1e6)+2)/4}if(R.status===TestState.UP){t=0,n=1/0;for(var s=0;s<P.length;s++){var r=y.threads[s].up;r.length>0&&(t+=r[r.length-1].bytes,r[r.length-1].duration<n&&(n=r[r.length-1].duration))}R.upBitPerSec=Math.max(0,8*t/(n/1e9)),R.upBitPerSecLog=(log10(R.upBitPerSec/1e6)+2)/4}}return R},e.prototype.getState=function(){return"INIT"},e}();
"use strict";function runCallback(){void 0!=geo_callback&&"function"==typeof geo_callback&&window.setTimeout(function(){geo_callback()},1)}function getCurLocation(){return curGeoPos}function getLocation(o,e,t,n){var a=document.getElementById("infogeo");if(geo_callback=n,!navigator.geolocation){var i=getCookie("coords");if(i){var r=JSON.parse(i);r&&r.lat>0&&r.long>0&&testVisualization.setLocation(r.lat,r.long)}else a.innerHTML=Lang.getString("NotSupported");return void runCallback()}runCallback(),TestEnvironment.getGeoTracker().start(function(o,e){if(!0===o);else switch(e.code){case e.PERMISSION_DENIED:a.innerHTML=Lang.getString("NoPermission");break;case e.TIMEOUT:break;case e.POSITION_UNAVAILABLE:a.innerHTML=Lang.getString("NotAvailable");break;case e.UNKNOWN_ERROR:a.innerHTML=Lang.getString("NotAvailable")+"("+e.code+")"}},TestEnvironment.getTestVisualization())}var curGeoPos,geo_callback,loc_timeout,GeoTracker=function(){function o(){e=new Array,a=!1}var e,t,n,a,i=null;o.prototype.start=function(o,l){if(t=o,void 0!==l&&(i=l),navigator.geolocation)navigator.geolocation.getCurrentPosition(function(o){0===e.length&&(a=!0,r(o))},c,{enableHighAccuracy:!1,timeout:2e3,maximumAge:6e4}),n=navigator.geolocation.watchPosition(r,c,{enableHighAccuracy:!0,timeout:1/0,maximumAge:0});else{var u=t;t=null,u(!1)}};var r=function(o){if(1===e.length&&a&&(e=new Array,a=!1),e.push({geo_lat:o.coords.latitude,geo_long:o.coords.longitude,accuracy:o.coords.accuracy,altitude:o.coords.altitude,bearing:o.coords.heading,speed:o.coords.speed,tstamp:o.timestamp,provider:"Browser"}),null!==t){var n=t;t=null,n(!0)}null!==i&&i.setLocation(o.coords.latitude,o.coords.longitude),l(o)},c=function(o){if(null!==t){var e=t;t=null,e(!1,o)}},l=function(o){var e=new Object;e.lat=o.coords.latitude,e.long=o.coords.longitude,e.accuracy=o.coords.accuracy,e.altitude=o.coords.altitude,e.heading=o.coords.heading,e.speed=o.coords.speed,e.tstamp=o.timestamp,e=JSON.stringify(e),setCookie("coords",e,3600)};return o.prototype.stop=function(){navigator.geolocation&&navigator.geolocation.clearWatch(n)},o.prototype.getResults=function(){return e},o}();void 0===window.setCookie&&(window.setCookie=function(o,e,t){var n=new Date,a=n.getTime();a+=1e3*t,n.setTime(a);var i=escape(e)+(null==t?";":"; expires="+n.toUTCString()+";");document.cookie=o+"="+i+" path=/;"});
"use strict";function RMBTIntermediateResult(){}var TestEnvironment=function(){var e=null,t=null;return{getTestVisualization:function(){return e},getGeoTracker:function(){return t},init:function(){e=new TestVisualization,t=new GeoTracker}}}(),TestState={WAIT:"WAIT",INIT:"INIT",INIT_DOWN:"INIT_DOWN",PING:"PING",DOWN:"DOWN",INIT_UP:"INIT_UP",UP:"UP",END:"END",ERROR:"ERROR",ABORTED:"ABORTED",LOCATE:"LOCATE",LOCABORTED:"LOCABORTED",SPEEDTEST_END:"SPEEDTEST_END",QOS_TEST_RUNNING:"QOS_TEST_RUNNING",QOS_END:"QOS_END"};RMBTIntermediateResult.prototype.setLogValues=function(){var e=function(e){return e<1e4?0:(2+Math.log(e/1e6/Math.LN10))/4};this.downBitPerSecLog=e(downBitPerSec),this.upBitPerSecLog=e(upBitPerSec)},RMBTIntermediateResult.prototype.pingNano=-1,RMBTIntermediateResult.prototype.downBitPerSec=-1,RMBTIntermediateResult.prototype.upBitPerSec=-1,RMBTIntermediateResult.prototype.status=TestState.INIT,RMBTIntermediateResult.prototype.progress=0,RMBTIntermediateResult.prototype.downBitPerSecLog=-1,RMBTIntermediateResult.prototype.upBitPerSecLog=-1,RMBTIntermediateResult.prototype.remainingWait=-1;
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},TestVisualization=function(){function t(){var t=getParam("nocanvas");y=!(Modernizr.canvas&&!t),y?($("#dashboard").detach(),$("#dashboard_easy").show()):($("#error_placeholder").hide(),$("#dashboard").show(),$("#dashboard_easy").detach(),r()),$("#error_placeholder").hide(),$("#loading-placeholder").hide(),R=document.getElementById("infogeo"),_=document.getElementById("infoserver"),O=document.getElementById("infoip"),B=document.getElementById("infostatus"),H=document.getElementById("infoprovider"),C=document.getElementById("activity-indicator")}function e(t,e){var r=0;switch(t){case"INIT":case"INIT_DOWN":r=Math.round(14*e);break;case"PING":r=14+Math.round(15*e);break;case"DOWN":r=29+Math.round(34*e);break;case"INIT_UP":r=63;break;case"UP":r=63+Math.round(33*e),r=Math.min(95,r);break;case"END":r=96;break;case"QOS_TEST_RUNNING":r=95;break;case TestState.SPEEDTEST_END:case TestState.QOS_END:r=95;break;case"ERROR":case"ABORTED":r=0}return r/96}function r(){l=document.getElementById("canvas-progress"),d=document.getElementById("canvas-downup"),c=l.getContext("2d"),u=d.getContext("2d"),p=l.width,S=l.height,m=new Image,f=c.createRadialGradient(p/2,S/2,110,p/2,S/2,118),f.addColorStop(0,"rgba(200,200,200,1)"),f.addColorStop(.3,"rgba(255,255,255,1)"),f.addColorStop(.7,"rgba(255,255,255,1)"),f.addColorStop(1,"rgba(200,200,200,1)"),M=u.createRadialGradient(p/2,S/2,110,p/2,S/2,118),M.addColorStop(0,"rgba(50,201,14,1)"),M.addColorStop(.3,"rgba(0,249,61,1)"),M.addColorStop(.7,"rgba(0,249,61,1)"),M.addColorStop(1,"rgba(50,201,14,1)")}function n(){c.clearRect(0,0,p,S),u.clearRect(0,0,p,S),c.beginPath(),c.strokeStyle=D,c.lineWidth=35,c.arc(p/2,S/2,114,0-150*Math.PI/180,.66*Math.PI,!1),c.stroke(),u.beginPath(),u.strokeStyle=D,u.lineWidth=35,u.arc(p/2,S/2,114,0*Math.PI/180,1.7*Math.PI,!1),u.stroke();var t=N*Math.PI/240,e=w*Math.PI/212;c.beginPath(),c.strokeStyle=f,c.lineWidth=18,c.arc(p/2,S/2,114,0-150*Math.PI/180,t-150*Math.PI/180,!1),c.stroke(),u.beginPath(),u.strokeStyle=M,u.lineWidth=18,u.arc(p/2,S/2,114,0-0*Math.PI/180,e-0*Math.PI/180,!1),u.stroke(),c.fillStyle="#FFF",c.font="bold 18pt tahoma",T=Math.floor(N/360*100)+"%";var r=c.measureText(T).width;c.fillText(T,p/2-r/2+4,S/2+7),null!==m&&""!==m.src&&u.drawImage(m,p/2-15,S/2-24)}function a(){var t,r,n,l,d,c,u,p=function(t){return t>100?-1:t>=10?0:t>=1?1:t>=.1?2:3},S="-",T="-",f="-",M=g.getIntermediateResult();if(null===M||M.progress===Q&&1!==Q&&F===M.status.toString()&&F!==TestState.QOS_TEST_RUNNING&&F!==TestState.QOS_END&&F!==TestState.SPEEDTEST_END)return void(b=setTimeout(a,250));Q=M.progress,F=M.status.toString(),null!==M&&(n=M.downBitPerSec,l=M.upBitPerSec,c=M.downBitPerSecLog,d=M.upBitPerSecLog,r=M.pingNano,t=M.status.toString(),u=M.progress),void 0!==A&&null!==A&&""!==A&&(_.innerHTML=A),void 0!==W&&null!==W&&""!==W&&(O.innerHTML=W),void 0!==x&&null!==x&&""!==x&&(H.innerHTML=x),r>0&&(f=r/1e6,f=f.formatNumber(p(f))+" "+Lang.getString("ms")),n>0&&(T=n/1e6,T=T.formatNumber(p(T))+" "+Lang.getString("Mbps")),l>0&&(S=l/1e6,S=S.formatNumber(p(S))+" "+Lang.getString("Mbps"));o(t),y?function(){var e=100*u;e=e<100?e.toPrecision(2):100,$("#progbar").css("width",Math.floor(210+2.1*e)+"px");var r=e/2;t===TestState.UP&&(r+=50),r=r<100?r.toPrecision(2):100,$("#progbar").html(r+"%"),$("#activity-indicator").html("("+e+"%)");var n=Math.floor(420*d);$("#ulbar").css("width",n+"px"),$("#ulbar").html(S),$("#showUp").html(S);var a=Math.floor(420*c);$("#dlbar").css("width",a+"px"),$("#dlbar").html(T),$("#showDown").html(T)}():function(){console.log(t+": "+u);var r=e(t,u);if(void 0!==(void 0===h?"undefined":_typeof(h))&&clearInterval(h),v=Math.round(360*r)+1,document.getElementById("showPing").innerHTML=f,document.getElementById("showDown").innerHTML=T,document.getElementById("showUp").innerHTML=S,"DOWN"===t){c>1&&(c=1),w=Math.round(360*c);var n=L+"speedtest/download-icon.png";m.src!==n&&(m.src=n)}else if("UP"===t){d>1&&(d=1),w=Math.round(360*d);var n=L+"speedtest/upload-icon.png";m.src!==n&&(m.src=n)}k=Math.max(1,v-N),h=setInterval(s,500/k)}(),"END"!==t&&"ERROR"!==t&&"ABORTED"!==t?b=setTimeout(a,250):"ERROR"===t||"ABORTED"===t||"END"===t&&i()}function o(t){switch(null!==U&&(U.stop(),U=null),t){case TestState.LOCATE:B.innerHTML=Lang.getString("Locating");var e={lines:7,length:0,width:3,radius:2,trail:50,speed:1.2,color:"#002D45"};U=new Spinner(e).spin(C);break;case TestState.INIT:case TestState.INIT_DOWN:B.innerHTML=Lang.getString("Initializing");break;case TestState.WAIT:B.innerHTML=Lang.getString("WaitForSlot");break;case TestState.INIT_UP:B.innerHTML=Lang.getString("Init_Upload");break;case TestState.PING:B.innerHTML=Lang.getString("Ping");break;case TestState.DOWN:B.innerHTML=Lang.getString("Download");break;case TestState.UP:B.innerHTML=Lang.getString("Upload");break;case TestState.QOS_TEST_RUNNING:E<0&&(E=(new Date).getTime());var r=(new Date).getTime(),n=Math.min(1,(r-E)/I);B.innerHTML=Lang.getString("QosTest")+" ("+Math.round(100*n)+"&nbsp;%)";break;case TestState.QOS_END:case TestState.SPEEDTEST_END:if(null!==g.getNdtStatus()&&"RUNNING"===g.getNdtStatus().toString()){var n=g.getNdtProgress();B.innerHTML=Lang.getString("NDT")+" ("+Math.round(100*n)+"&nbsp;%)"}break;case TestState.END:B.innerHTML=Lang.getString("Finished");break;case TestState.ERROR:B.innerHTML=Lang.getString("Error"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("ErrorOccuredDuringTest")+"</p>"),F!==t&&(show_errorPopup(),F=t);break;case TestState.ABORTED:B.innerHTML=Lang.getString("Aborted"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("PrematureEnd")+"</p>"),show_errorPopup();break;case"JAVAERROR":B.innerHTML=Lang.getString("Aborted"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("AppletCouldNotBeLoaded")+"</p>"),show_errorPopup();break;case TestState.LOCABORTED:B.innerHTML=Lang.getString("Init_applet"),noJava?start_jstest():start_test();break;default:console.log("Unknown test state: "+t)}}function i(){var t="/"+selectedLanguage+"/Verlauf";(preferredTest===TestTypes.Java||getParam("Java"))&&(t+="?Java=True"),t+="#",t+=G,setTimeout(function(){window.location.href=t},2e3)}function s(){N>=v&&clearInterval(h),N<v&&N++,P!==v&&(N=P,P=v),n()}var g,l,d,c,u,p,S,T,h,b,m,f,M,L="../img/",I=1e4,E=-1,y=!1,N=0,v=0,P=0,w=0,k=0,D="#2E4653",R=null,_=null,O=null,B=null,H=null,U=null,C=null;t.prototype.setRMBTTest=function(t){g=t};var A=null,W=null,x=null,G="";t.prototype.updateInfo=function(t,e,r,n){A=t,W=e,x=r,G=n},t.prototype.setStatus=function(t){o(t)},t.prototype.setLocation=function(t,e){var r=function(t,e,r){var n=a<0?r:e,a=Math.floor(Math.abs(t));return n+" "+a+"&deg; "+(60*(Math.abs(t)-a)).toFixed(3)+"'"},n=document.getElementById("infogeo");t=r(t,Lang.getString("North"),Lang.getString("South")),e="<br />"+r(e,Lang.getString("East"),Lang.getString("West")),n.innerHTML=t+" "+e},t.prototype.startTest=function(){close_errorPopup(),a()};var Q=-1,F=-1;return t}();
"use strict";function RMBTTestConfig(){}function RMBTTestThread(t){var e=function(t){$("#debug").prepend(t+"\n"),console.log(t)},s={},o=t;return{setState:function(t){this.state=t,e(this.id+": reached state: "+t);var r=this;o.await(function(){if(e(r.id+": all threads reached state: "+t),void 0!==s[t]&&null!==s[t]){(0,s[t])()}else e(r.id+": no callback registered")})},onStateEnter:function(t,e){s[t]=e},retriggerState:function(){setState(this.state)},triggerNextState:function(){var t=[TestState.INIT,TestState.INIT_DOWN,TestState.PING,TestState.DOWN,TestState.INIT_UP,TestState.UP,TestState.END];if(this.state!==TestState.END){var s=t[t.indexOf(this.state)+1];e(this.id+": triggered state "+s),this.setState(s)}},id:-1,socket:null,result:new RMBTThreadTestResult}}function RMBTTestResult(){this.pings=new Array,this.speedItems=new Array,this.threads=new Array}function RMBTThreadTestResult(){this.down=new Array,this.up=new Array,this.pings=new Array}function RMBTPingResult(){}RMBTTestConfig.prototype.version="0.3",RMBTTestConfig.prototype.language=selectedLanguage,RMBTTestConfig.prototype.uuid="",RMBTTestConfig.prototype.type="DESKTOP",RMBTTestConfig.prototype.version_code="0.3",RMBTTestConfig.prototype.client_version="0.3",RMBTTestConfig.prototype.client_software_version="0.6.1",RMBTTestConfig.prototype.os_version=1,RMBTTestConfig.prototype.platform="RMBTws",RMBTTestConfig.prototype.model="Websocket",RMBTTestConfig.prototype.product="Chrome",RMBTTestConfig.prototype.client="RMBTws",RMBTTestConfig.prototype.timezone="Europe/Vienna",RMBTTestConfig.prototype.controlServerURL=controlProxy+"/"+wspath,RMBTTestConfig.prototype.controlServerRegistrationResource="/testRequest",RMBTTestConfig.prototype.controlServerResultResource="/result",RMBTTestConfig.prototype.controlServerDataCollectorResource="/requestDataCollector",RMBTTestConfig.prototype.pretestDurationMs=2e3,RMBTTestConfig.prototype.savedChunks=4,RMBTTestConfig.prototype.measurementPointsTimespan=40,RMBTTestConfig.prototype.numPings=10,RMBTTestConfig.prototype.downloadThreadsLimitsMbit={0:1,1:3,100:5},RMBTTestConfig.prototype.uploadThreadsLimitsMbit={0:1,30:2,80:3,150:5},RMBTTestConfig.prototype.userServerSelection=void 0!==window.userServerSelection?userServerSelection:0;var RMBTControlServerRegistrationResponse=function(){function t(t){this.client_remote_ip=t.client_remote_ip,this.provider=t.provider,this.test_server_encryption=t.test_server_encryption,this.test_numthreads=t.test_numthreads,this.test_server_name=t.test_server_name,this.test_uuid=t.test_uuid,this.test_id=t.test_id,this.test_token=t.test_token,this.test_server_address=t.test_server_address,this.test_duration=parseInt(t.test_duration),this.result_url=t.result_url,this.test_wait=t.test_wait,this.test_server_port=t.test_server_port}return t.prototype.client_remote_ip,t.prototype.provider,t.prototype.test_server_encryption="",t.prototype.test_numthreads,t.prototype.test_server_name,t.prototype.test_uuid,t.prototype.test_id,t.prototype.test_token,t.prototype.test_server_address,t.prototype.test_duration,t.prototype.result_url,t.prototype.test_wait,t.prototype.test_server_port,t}();RMBTTestResult.prototype.addThread=function(t){this.threads.push(t)},RMBTTestResult.prototype.ip_local,RMBTTestResult.prototype.ip_server,RMBTTestResult.prototype.port_remote,RMBTTestResult.prototype.num_threads,RMBTTestResult.prototype.encryption="NONE",RMBTTestResult.prototype.ping_shortest=-1,RMBTTestResult.prototype.ping_median=-1,RMBTTestResult.prototype.client_version,RMBTTestResult.prototype.pings=new Array,RMBTTestResult.prototype.speed_download=-1,RMBTTestResult.prototype.speed_upload=-1,RMBTTestResult.prototype.speedItems=new Array,RMBTTestResult.prototype.bytes_download=-1,RMBTTestResult.prototype.nsec_download=-1,RMBTTestResult.prototype.bytes_upload=-1,RMBTTestResult.prototype.nsec_upload=-1,RMBTTestResult.prototype.totalDownBytes=-1,RMBTTestResult.prototype.totalUpBytes=-1,RMBTTestResult.prototype.beginTime=-1,RMBTTestResult.prototype.geoLocations=new Array,RMBTTestResult.prototype.calculateAll=function(){for(var t=function(t,e){for(var s=t.length,o=1/0,r=0;r<s;r++){var n=e(t[r]);n.length>0&&n[n.length-1].duration<o&&(o=n[n.length-1].duration)}for(var i=0,r=0;r<s;r++){var p=t[r];if(null!==p&&e(p).length>0){for(var a=e(p).length,T=0;T<e(p).length;T++)if(e(p)[T].duration>o){a=T;break}var l;if(a===e(p).length)l=e(p)[e(p).length-1].bytes;else{var u=0===a?0:e(p)[a-1].bytes,d=e(p)[a].bytes,R=d-u,h=0===a?0:e(p)[a-1].duration,y=e(p)[a].duration,_=y-h,c=o-h,g=c/_,B=Math.round(R*g);B<0&&(B=0),l=u+B}i+=l}}return{bytes:i,nsec:o,speed:8*i/(o/1e9)/1e3}},e=0;e<this.threads.length;e++){var s=this.threads[e].down;if(s.length>0)for(var o=0;o<s.length;o++)this.speedItems.push({direction:"download",thread:e,time:s[o].duration,bytes:s[o].bytes})}var r=t(this.threads,function(t){return t.down});this.speed_download=r.speed,this.bytes_download=r.bytes,this.nsec_download=r.nsec;for(var e=0;e<this.threads.length;e++){var n=this.threads[e].up;if(n.length>0)for(var o=0;o<n.length;o++)this.speedItems.push({direction:"upload",thread:e,time:n[o].duration,bytes:n[o].bytes})}var r=t(this.threads,function(t){return t.up});this.speed_upload=r.speed,this.bytes_upload=r.bytes,this.nsec_upload=r.nsec;for(var i=this.threads[0].pings,p=1/0,e=0;e<i.length;e++)this.pings.push({value:i[e].client,value_server:i[e].server,time_ns:i[e].timeNs}),i[e].client<p&&(p=i[e].client);this.ping_shortest=p},RMBTThreadTestResult.prototype.down,RMBTThreadTestResult.prototype.up,RMBTThreadTestResult.prototype.pings,RMBTThreadTestResult.prototype.totalDownBytes=-1,RMBTThreadTestResult.prototype.totalUpBytes=-1,RMBTPingResult.prototype.client=-1,RMBTPingResult.prototype.server=-1,RMBTPingResult.prototype.timeNs=-1;var RMBTError={NOT_SUPPORTED:"WebSockets are not supported",SOCKET_INIT_FAILED:"WebSocket initialization failed",CONNECT_FAILED:"connecting to test server failed"};
"use strict";function nowNs(){return Math.round(1e3*window.performance.now()*1e3)}!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),void 0===window.performance&&(window.performance={}),!window.performance.now||void 0===window.performance.now){var n=Date.now();performance.timing&&performance.timing.navigationStart&&(n=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-n}}}();var CyclicBarrier=function(){function n(n){o=n}function r(){var n=e.slice();e=new Array;for(var r=0;r<o;r++)window.setTimeout(n[r],1)}var o,e=new Array;return n.prototype.await=function(n){e.push(n),e.length===o&&r()},n}();Math.median=function(n){n.sort(function(n,r){return n-r});var r=Math.floor(n.length/2);return n.length%2?n[r]:(n[r-1]+n[r])/2};
//# sourceMappingURL=rmbtws.min.js.map
