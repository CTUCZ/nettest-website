/*!******************************************************************************
 * @license
 * Copyright 2015-2017 Thomas Schreiber
 * Copyright 2017      Rundfunk und Telekom Regulierungs-GmbH (RTR-GmbH)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The source code for this project is available at
 * https://github.com/rtr-nettest/rmbtws
 *****************************************************************************!*/
"use strict";var RMBTTest=function(){function e(e,t){_=e,b=t,E=TestState.INIT,f=log.getLogger("rmbtws"),O=new RMBTIntermediateResult}function t(e){void 0!==E&&E===e||(E=e,w=nowMs(),N&&N(e))}function n(e,n,r){var u=(e.test_server_encryption?"wss://":"ws://")+e.test_server_address+":"+e.test_server_port;f.debug(u);var l=function(){return{IGNORE:function(){},CALLGLOBALHANDLER:function(){G(RMBTError.CONNECT_FAILED)},TRYRECONNECT:function(){G(RMBTError.CONNECT_FAILED)}}}();n.onStateEnter(TestState.INIT_DOWN,function(){t(TestState.INIT_DOWN),f.debug(n.id+": start short download"),p=m,a(n,_.pretestDurationMs)}),n.onStateEnter(TestState.PING,function(){t(TestState.PING),f.debug(n.id+": starting ping"),0===n.id?i(n):n.triggerNextState()}),n.onStateEnter(TestState.DOWN,function(){if(t(TestState.DOWN),C.length>0){var s=o(C,_.downloadThreadsLimitsMbit,!1);U=s.numThreads,S&&(p=s.chunkSize),C=[]}n.id<U?d(n,e.test_duration):n.triggerNextState()}),n.onStateEnter(TestState.INIT_UP,function(){t(TestState.INIT_UP),p=m,c(n,_.pretestDurationMs)}),n.onStateEnter(TestState.UP,function(){if(t(TestState.UP),C.length>0){var s=o(C,_.uploadThreadsLimitsMbit,!0);D=s.numThreads,S&&(p=s.chunkSize),C=[]}n.id<D?g(n,e.test_duration):(n.socket.onerror=l.IGNORE,n.socket.onclose=l.IGNORE,n.socket.readyState!==WebSocket.CLOSED&&n.socket.close(),n.triggerNextState())}),n.onStateEnter(TestState.END,function(){n.socket.readyState!==WebSocket.CLOSED&&n.socket.close(),0===n.id&&r()}),n.setState(TestState.INIT),t(TestState.INIT),s(n,u,e.test_token,l.CALLGLOBALHANDLER)}function s(e,t,n,s){try{e.socket=new WebSocket(t)}catch(e){return void G(RMBTError.SOCKET_INIT_FAILED)}e.socket.binaryType="arraybuffer",e.socket.onerror=s,e.socket.onclose=s,e.socket.onmessage=function(t){if(0===t.data.indexOf("CHUNKSIZE")){var o=t.data.trim().split(" ");4===o.length?(I=parseInt(o[1]),m=parseInt(o[2]),v=parseInt(o[3])):(I=parseInt(o[1]),m=I),f.debug(e.id+": Chunksizes: min "+m+", max: "+v+", default: "+I)}else if(0===t.data.indexOf("RMBTv")){var a=t.data.substring(5).trim();_.client_version=a,0===a.indexOf("1.")?S=!0:0===a.indexOf("0.3")?S=!1:f.warn("unknown server version: "+a)}else"ACCEPT TOKEN QUIT\n"===t.data?e.socket.send("TOKEN "+n+"\n"):"OK\n"===t.data&&e.state===TestState.INIT?f.debug(e.id+": Token accepted"):"ERR\n"===t.data?(s(),f.error("got error msg")):0===t.data.indexOf("ACCEPT GETCHUNKS")&&e.triggerNextState()}}function o(e,t,n){A=e.reduce(function(e,t){return e+t}),f.debug("total: circa "+A/1e3+" KB/sec"),f.debug("total: circa "+8*A/1e6+" MBit/sec");var s=8*A/1e6,o=0;Object.keys(t).forEach(function(e){s>e&&(o=t[e])}),o=Math.min(L,o),f.debug("set number of threads to be used in upcoming speed test to: "+o);var a=A/(1e3/(_.measurementPointsTimespan/2));if(a-=a%1024,a=Math.max(m,a),a=Math.min(v,a),f.debug("calculated chunksize for upcoming speed test "+a/1024+" KB"),n){var r=Number.POSITIVE_INFINITY;Object.keys(R).forEach(function(e){Math.abs(a-e)<Math.abs(a-r)?("string"==typeof e&&(e=parseInt(e)),r=e):(delete R[e],delete y[e])}),a=r,f.debug("fallback to existing chunksize for upcoming speed test "+a/1024+" KB")}return{numThreads:o,chunkSize:a,bytesPerSecs:A}}function a(e,t){var n=e.socket.onmessage,s=nowMs(),o=1,a=0,i=p;!function u(){r(e,o,i,function(r){a+=o*i,f.debug(e.id+": "+r);var d=parseInt(r.substring(5));nowMs()-s>t?(C.push(o*i/(d/1e9)),e.socket.onmessage=n):o<8||!S?(o*=2,u()):(i=Math.min(2*i,v),u())})}()}function r(e,t,n,s){var o=e.socket,a=t,r=p*t,i=0,u=null,d=function(e,t){var n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},c=function(e){if("string"!=typeof e.data){var t=!1;u=null===u?new Uint8Array(e.data):d(u,new Uint8Array(e.data)),i+=e.data.byteLength,u.length===n&&(a--,t=!0),t&&255===u[u.length-1]?(o.onmessage=function(e){var t=e.data;s(t)},o.send("OK\n"),y[n]=u.buffer,u=null):(R.hasOwnProperty(n)||(R[n]=[]),t&&(R[n].length<_.savedChunks&&R[n].push(u.buffer),u=null))}};o.onmessage=c,f.debug(e.id+": downloading "+t+" chunks, "+r/1e3+" KB");var l="GETCHUNKS "+t+(n!==I?" "+n:"")+"\n";o.send(l)}function i(e){var t=1/0,n=e.socket.onmessage,s=_.numPings;u(e,function o(a){if(s--,e.result.pings.push(a),a.client<t&&(t=a.client),f.debug(e.id+": PING "+a.client+" ns client; "+a.server+" ns server"),s>0)e.socket.onmessage=function(t){"ACCEPT GETCHUNKS GETTIME PUT PUTNORESULT PING QUIT\n"===t.data?u(e,o):f.error("unexpected error during ping test")};else{for(var r=[],i=0;i<e.result.pings.length;i++)r.push(e.result.pings[i].client);h.ping_median=Math.median(r),f.debug(e.id+": shortest: "+Math.round(t/1e3)/1e3+" ms"),h.ping_shortest=t,e.socket.onmessage=n}})}function u(e,t){var n=void 0,s=void 0,o=function(o){if("PONG\n"===o.data){var a=nowNs();s=a-n,e.socket.send("OK\n")}else if(0===o.data.indexOf("TIME")){var r=new RMBTPingResult;r.client=s,r.server=parseInt(o.data.substring(5)),r.timeNs=n,t(r)}};e.socket.onmessage=o,n=nowNs(),e.socket.send("PING\n")}function d(e,t){var n=e.socket.onmessage,s=0,o=0,a=-1,r=void 0,i=void 0,u=null,d=null;r=window.setInterval(function(){if(null!==u&&a!==o){a=o;var t=nowNs();f.debug(e.id+": "+i+"|"+_.measurementPointsTimespan+"|"+t+"|"+o);var c=new Uint8Array(u,u.byteLength-1,1),g=d-l;e.result.down.push({duration:g,bytes:s}),i=t,c[0]>=255&&(f.debug(e.id+": received end chunk"),window.clearInterval(r),e.socket.onmessage=function(t){f.debug(t.data),e.socket.onmessage=n},e.socket.send("OK\n"))}},_.measurementPointsTimespan);var c=function(e){o++,s+=e.data.byteLength,d=nowNs(),u=e.data};e.socket.onmessage=c;var l=nowNs();e.socket.send("GETTIME "+t+(p!==I?" "+p:"")+"\n")}function c(e,t){var n=e.socket.onmessage,s=nowMs(),o=1,a=0,r=p;window.setTimeout(function(){var e=nowMs(),n=e-s;f.debug("diff:"+(n-t)+" ("+(n-t)/t+" %)")},t);!function i(){l(e,o,r,function(u){if(a+=o*r,f.debug(e.id+": "+u),nowMs()-s>t){e.socket.onmessage=n;var d=parseInt(u.substring(5));C.push(o*r/(d/1e9))}else{var c=2*r;o<8||!y.hasOwnProperty(c)||!S?(o*=2,i()):(r=Math.min(2*r,v),i())}})}()}function l(e,t,n,s){var o=e.socket;o.onmessage=function(e){0!==e.data.indexOf("OK")&&0!==e.data.indexOf("ACCEPT")&&s(e.data)},f.debug(e.id+": uploading "+t+" chunks, "+n*t/1e3+" KB"),o.send("PUTNORESULT"+(S?" "+n:"")+"\n");for(var a=0;a<t;a++){var r=void 0;r=a===t-1?y[n]:R[n][0],o.send(r)}}function g(e,t){var n=e.socket.onmessage,s=A/2/D,o=1.5*A/D,a=document.hidden?o:s,r=function(){a=document.hidden?o:s,f.debug("document visibility changed to: "+document.hidden)};document.addEventListener("visibilitychange",r);var i=Math.ceil(A/D/p),u=!1,d=!0,c=-1,l=0,g=function s(){u||(f.debug(e.id+": is 7.2 sec in, got data for "+c),c<1e9*t&&l<3e3?(window.setTimeout(s,250),l+=250):(f.debug(e.id+": didn't finish, timeout extended by "+l+" ms, last info for "+c),e.socket.onerror=function(){},e.socket.onclose=function(){},e.socket.close(),e.socket.onmessage=n,f.debug(e.id+": socket now closed: "+e.socket.readyState),document.removeEventListener("visibilitychange",r),e.triggerNextState()))},T=function t(){if(e.socket.bufferedAmount<a)for(var n=0;n<i;n++)e.socket.send(R[p][n%R[p].length]);if(!d)return!1;setTimeout(t,0)};window.setTimeout(g,1e3*t+200),window.setTimeout(function(){d=!1,e.socket.onclose=function(){},e.socket.send(y[p]),e.socket.send("QUIT\n")},1e3*t),f.debug(e.id+": set timeout");var v=1e6*_.measurementPointsTimespan,m=/TIME (\d+) BYTES (\d+)/,S=/TIME (\d+)/,b=function(t){"OK\n"===t.data&&T();var s=m.exec(t.data);if(null!==s){var o={duration:parseInt(s[1]),bytes:parseInt(s[2])};o.duration-c>v&&(c=o.duration,e.result.up.push(o))}else null!==(s=S.exec(t.data))&&(u=!0,f.debug("Upload duration: "+s[1]),e.socket.onmessage=n,document.removeEventListener("visibilitychange",r))};e.socket.onmessage=b,e.socket.send("PUT"+(p!==I?" "+p:"")+"\n")}function T(e){return{client_language:"de",client_name:_.client,client_uuid:_.uuid,client_version:_.client_version,client_software_version:_.client_software_version,geoLocations:h.geoLocations,model:_.model,network_type:98,platform:_.platform,product:_.product,pings:h.pings,test_bytes_download:h.bytes_download,test_bytes_upload:h.bytes_upload,test_nsec_download:h.nsec_download,test_nsec_upload:h.nsec_upload,test_num_threads:U,num_threads_ul:D,test_ping_shortest:h.ping_shortest,test_speed_download:h.speed_download,test_speed_upload:h.speed_upload,test_token:e.test_token,test_uuid:e.test_uuid,time:h.beginTime,timezone:"Europe/Vienna",type:"DESKTOP",version_code:"1",speed_detail:h.speedItems,user_server_selection:_.userServerSelection}}var f=null,p=void 0,v=4194304,m=void 0,I=void 0,S=!1,_=void 0,b=null,h=null,k=null,N=null,E=void 0,w=void 0,M={durationInitMs:2500,durationPingMs:500,durationUpMs:-1,durationDownMs:-1},O=void 0,P=[],R={},y={},B=void 0,L=void 0,U=0,D=0,C=[],A=0;e.prototype.onError=function(e){k=e},e.prototype.onStateChange=function(e){N=e};var G=function(e){if(f.debug("error occurred during websocket test"),e!==RMBTError.NOT_SUPPORTED&&t(TestState.ERROR),null!==k){var n=k;k=null,n()}};return e.prototype.startTest=function(){if(void 0===window.WebSocket)return void G(RMBTError.NOT_SUPPORTED);t(TestState.INIT),h=new RMBTTestResult,b.getDataCollectorInfo(),b.obtainControlServerRegistration(function(e){L=parseInt(e.test_numthreads),B=new CyclicBarrier(L),M.durationDownMs=1e3*e.test_duration,M.durationUpMs=1e3*e.test_duration,null!==TestEnvironment.getTestVisualization()&&TestEnvironment.getTestVisualization().updateInfo(e.test_server_name,e.client_remote_ip,e.provider,e.test_uuid);var s=function(){f.debug("got geolocation, obtaining token and websocket address"),t(TestState.WAIT),window.setTimeout(function(){t(TestState.INIT),h.beginTime=Date.now();for(var s=0;s<L;s++){var a=new RMBTTestThread(B);a.id=s,h.addThread(a.result),n(e,a,function(){f.info("All tests finished"),o.stop(),h.geoLocations=o.getResults(),h.calculateAll(),b.submitResults(T(e),function(){t(TestState.END)},function(){G(RMBTError.SUBMIT_FAILED)})}),P.push(a)}},1e3*e.test_wait)},o=void 0;null!==TestEnvironment.getGeoTracker()?(o=TestEnvironment.getGeoTracker(),s()):(o=new GeoTracker,f.debug("getting geolocation"),o.start(function(){s()},TestEnvironment.getTestVisualization()))},function(){G(RMBTError.REGISTRATION_FAILED)})},e.prototype.getIntermediateResult=function(){O.status=E;var e=nowNs()/1e6-w;switch(O.status){case TestState.WAIT:O.progress=0;break;case TestState.INIT:case TestState.INIT_DOWN:case TestState.INIT_UP:O.progress=e/M.durationInitMs;break;case TestState.PING:O.progress=e/M.durationPingMs;break;case TestState.DOWN:O.progress=e/M.durationDownMs;break;case TestState.UP:O.progress=e/M.durationUpMs;break;case TestState.END:O.progress=1;break;case TestState.ERROR:case TestState.ABORTED:O.progress=0}if(isNaN(O.progress)&&(O.progress=0),O.progress=Math.min(1,O.progress),null!==h){if(O.status!==TestState.PING&&O.status!==TestState.DOWN||(O.pingNano=h.ping_median),O.status===TestState.DOWN||O.status==TestState.INIT_UP){var t=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(h.threads,function(e){return e.down});O.downBitPerSec=t.speed,O.downBitPerSecLog=(Math.log10(O.downBitPerSec/1e6)+2)/4}if(O.status===TestState.UP||O.status==TestState.INIT_UP){var n=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(h.threads,function(e){return e.up});O.upBitPerSec=n.speed,O.upBitPerSecLog=(Math.log10(O.upBitPerSec/1e6)+2)/4}}return O},e.prototype.getState=function(){return"INIT"},e}();
"use strict";function runCallback(){void 0!=geo_callback&&"function"==typeof geo_callback&&window.setTimeout(function(){geo_callback()},1)}function getCurLocation(){return curGeoPos}function getLocation(o,t,e,n){var i=document.getElementById("infogeo");if(geo_callback=n,!navigator.geolocation){var a=getCookie("coords");if(a){var c=JSON.parse(a);c&&c.lat>0&&c.long>0&&testVisualization.setLocation(c.lat,c.long)}else i.innerHTML=Lang.getString("NotSupported");return void runCallback()}runCallback(),TestEnvironment.getGeoTracker().start(function(o,t){if(!0!==o)switch(t.code){case t.PERMISSION_DENIED:i.innerHTML=Lang.getString("NoPermission");break;case t.TIMEOUT:break;case t.POSITION_UNAVAILABLE:i.innerHTML=Lang.getString("NotAvailable");break;case t.UNKNOWN_ERROR:i.innerHTML=Lang.getString("NotAvailable")+"("+t.code+")"}},TestEnvironment.getTestVisualization())}var curGeoPos=void 0,geo_callback=void 0,loc_timeout=void 0,GeoTracker=function(){function o(){t=[],a=!1}var t=void 0,e=void 0,n=null,i=void 0,a=void 0;o.prototype.start=function(o,l){if(e=o,void 0!==l&&(n=l),navigator.geolocation)navigator.geolocation.getCurrentPosition(function(o){0===t.length&&(a=!0,c(o))},r,{enableHighAccuracy:!1,timeout:2e3,maximumAge:6e4}),i=navigator.geolocation.watchPosition(c,r,{enableHighAccuracy:!0,timeout:1/0,maximumAge:0});else{var u=e;e=null,u(!1)}};var c=function(o){if(1===t.length&&a&&(t=[],a=!1),t.push({geo_lat:o.coords.latitude,geo_long:o.coords.longitude,accuracy:o.coords.accuracy,altitude:o.coords.altitude,bearing:o.coords.heading,speed:o.coords.speed,tstamp:o.timestamp,provider:"Browser"}),null!==e){var i=e;e=null,i(!0)}null!==n&&n.setLocation(o.coords.latitude,o.coords.longitude),l(o)},r=function(o){if(null!==e){var t=e;e=null,t(!1,o)}},l=function(o){var t={};t.lat=o.coords.latitude,t.long=o.coords.longitude,t.accuracy=o.coords.accuracy,t.altitude=o.coords.altitude,t.heading=o.coords.heading,t.speed=o.coords.speed,t.tstamp=o.timestamp,t=JSON.stringify(t),setCookie("coords",t,3600)};return o.prototype.stop=function(){navigator.geolocation&&navigator.geolocation.clearWatch(i)},o.prototype.getResults=function(){return t},o}();void 0===window.setCookie&&(window.setCookie=function(o,t,e){var n=new Date,i=n.getTime();i+=1e3*e,n.setTime(i);var a=encodeURIComponent(t)+(null==e?";":"; expires="+n.toUTCString()+";");document.cookie=o+"="+a+" path=/;"});
"use strict";var RMBTControlServerCommunication=function(){function e(e){t=e,r=log.getLogger("rmbtws")}var r=void 0,t=void 0;return e.prototype.obtainControlServerRegistration=function(e,o){var n={version:t.version,language:t.language,uuid:t.uuid,type:t.type,version_code:t.version_code,client:t.client,timezone:t.timezone,time:(new Date).getTime()};Object.assign(n,t.additionalRegistrationParameters),"undefined"!=typeof userServerSelection&&userServerSelection>0&&"undefined"!=typeof UserConf&&void 0!==UserConf.preferredServer&&"default"!==UserConf.preferredServer&&(n.prefer_server=UserConf.preferredServer,n.user_server_selection=userServerSelection),$.ajax({url:t.controlServerURL+t.controlServerRegistrationResource,type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(n),success:function(r){var t=new RMBTControlServerRegistrationResponse(r);e(t)},error:function(){r.error("error getting testID"),o()}})},e.prototype.getDataCollectorInfo=function(){$.ajax({url:t.controlServerURL+t.controlServerDataCollectorResource,type:"get",dataType:"json",contentType:"application/json",success:function(e){t.product=e.agent.substring(0,Math.min(150,e.agent.length)),t.model=e.product,t.os_version=e.version},error:function(){r.error("error getting data collection response")}})},e.prototype.submitResults=function(e,o,n){Object.assign(e,t.additionalSubmissionParameters);var i=JSON.stringify(e);r.debug("Submit size: "+i.length),$.ajax({url:t.controlServerURL+t.controlServerResultResource,type:"post",dataType:"json",contentType:"application/json",data:i,success:function(t){r.debug("https://develop.netztest.at/en/Verlauf?"+e.test_uuid),o(!0)},error:function(){r.error("error submitting results"),n(!1)}})},e}();
"use strict";function RMBTIntermediateResult(){}var TestEnvironment=function(){var e=null,t=null;return{getTestVisualization:function(){return e},getGeoTracker:function(){return t},init:function(r,n){void 0===r&&(r=new TestVisualization),void 0===n&&(n=new GeoTracker),e=r,t=n}}}(),TestState={WAIT:"WAIT",INIT:"INIT",INIT_DOWN:"INIT_DOWN",PING:"PING",DOWN:"DOWN",INIT_UP:"INIT_UP",UP:"UP",END:"END",ERROR:"ERROR",ABORTED:"ABORTED",LOCATE:"LOCATE",LOCABORTED:"LOCABORTED",SPEEDTEST_END:"SPEEDTEST_END",QOS_TEST_RUNNING:"QOS_TEST_RUNNING",QOS_END:"QOS_END"};RMBTIntermediateResult.prototype.setLogValues=function(){var e=function(e){return e<1e4?0:(2+Math.log(e/1e6/Math.LN10))/4};this.downBitPerSecLog=e(downBitPerSec),this.upBitPerSecLog=e(upBitPerSec)},RMBTIntermediateResult.prototype.pingNano=-1,RMBTIntermediateResult.prototype.downBitPerSec=-1,RMBTIntermediateResult.prototype.upBitPerSec=-1,RMBTIntermediateResult.prototype.status=TestState.INIT,RMBTIntermediateResult.prototype.progress=0,RMBTIntermediateResult.prototype.downBitPerSecLog=-1,RMBTIntermediateResult.prototype.upBitPerSecLog=-1,RMBTIntermediateResult.prototype.remainingWait=-1;
"use strict";var TestVisualization=function(){function t(){var t=getParam("nocanvas");u=!Modernizr.canvas||t,u?($("#dashboard").detach(),$("#dashboard_easy").show()):($("#error_placeholder").hide(),$("#dashboard").show(),$("#dashboard_easy").detach(),a()),$("#error_placeholder").hide(),$("#loading-placeholder").hide(),R=document.getElementById("infogeo"),_=document.getElementById("infoserver"),O=document.getElementById("infoip"),B=document.getElementById("infostatus"),H=document.getElementById("infoprovider"),C=document.getElementById("activity-indicator")}function e(t,e){var a=0;switch(t){case"INIT":case"INIT_DOWN":a=Math.round(14*e);break;case"PING":a=14+Math.round(15*e);break;case"DOWN":a=29+Math.round(34*e);break;case"INIT_UP":a=63;break;case"UP":a=63+Math.round(33*e),a=Math.min(95,a);break;case"END":a=96;break;case"QOS_TEST_RUNNING":a=95;break;case TestState.SPEEDTEST_END:case TestState.QOS_END:a=95;break;case"ERROR":case"ABORTED":a=0}return a/96}function a(){p=document.getElementById("canvas-progress"),S=document.getElementById("canvas-downup"),T=p.getContext("2d"),h=S.getContext("2d"),v=p.width,b=p.height,k=new Image,D=T.createRadialGradient(v/2,b/2,110,v/2,b/2,118),D.addColorStop(0,"rgba(200,200,200,1)"),D.addColorStop(.3,"rgba(255,255,255,1)"),D.addColorStop(.7,"rgba(255,255,255,1)"),D.addColorStop(1,"rgba(200,200,200,1)"),y=h.createRadialGradient(v/2,b/2,110,v/2,b/2,118),y.addColorStop(0,"rgba(50,201,14,1)"),y.addColorStop(.3,"rgba(0,249,61,1)"),y.addColorStop(.7,"rgba(0,249,61,1)"),y.addColorStop(1,"rgba(50,201,14,1)")}function r(){T.clearRect(0,0,v,b),h.clearRect(0,0,v,b),T.beginPath(),T.strokeStyle=f,T.lineWidth=35,T.arc(v/2,b/2,114,0-150*Math.PI/180,.66*Math.PI,!1),T.stroke(),h.beginPath(),h.strokeStyle=f,h.lineWidth=35,h.arc(v/2,b/2,114,0,1.7*Math.PI,!1),h.stroke();var t=m*Math.PI/240,e=E*Math.PI/212;T.beginPath(),T.strokeStyle=D,T.lineWidth=18,T.arc(v/2,b/2,114,0-150*Math.PI/180,t-150*Math.PI/180,!1),T.stroke(),h.beginPath(),h.strokeStyle=y,h.lineWidth=18,h.arc(v/2,b/2,114,0,e,!1),h.stroke(),T.fillStyle="#FFF",T.font="bold 18pt tahoma",N=Math.floor(m/360*100)+"%";var a=T.measureText(N).width;T.fillText(N,v/2-a/2+4,b/2+7),null!==k&&""!==k.src&&h.drawImage(k,v/2-15,b/2-24)}function n(){var t=function(t){return t>100?-1:t>=10?0:t>=1?1:t>=.1?2:3},a=void 0,r=void 0,g=void 0,l=void 0,p=void 0,S=void 0,T=void 0,h="-",v="-",b="-",M=c.getIntermediateResult();if(null===M||M.progress===Q&&1!==Q&&F===M.status.toString()&&F!==TestState.QOS_TEST_RUNNING&&F!==TestState.QOS_END&&F!==TestState.SPEEDTEST_END)return void(w=setTimeout(n,250));Q=M.progress,F=M.status.toString(),null!==M&&(g=M.downBitPerSec,l=M.upBitPerSec,S=M.downBitPerSecLog,p=M.upBitPerSecLog,r=M.pingNano,a=M.status.toString(),T=M.progress),void 0!==A&&null!==A&&""!==A&&(_.innerHTML=A),void 0!==W&&null!==W&&""!==W&&(O.innerHTML=W),void 0!==x&&null!==x&&""!==x&&(H.innerHTML=x),r>0&&(b=r/1e6,b=b.formatNumber(t(b))+" "+Lang.getString("ms")),g>0&&(v=g/1e6,v=v.formatNumber(t(v))+" "+Lang.getString("Mbps")),l>0&&(h=l/1e6,h=h.formatNumber(t(h))+" "+Lang.getString("Mbps"));o(a),u?function(){var t=100*T;t=t<100?t.toPrecision(2):100,$("#progbar").css("width",Math.floor(210+2.1*t)+"px");var e=t/2;a===TestState.UP&&(e+=50),e=e<100?e.toPrecision(2):100,$("#progbar").html(e+"%"),$("#activity-indicator").html("("+t+"%)");var r=Math.floor(420*p);$("#ulbar").css("width",r+"px"),$("#ulbar").html(h),$("#showUp").html(h);var n=Math.floor(420*S);$("#dlbar").css("width",n+"px"),$("#dlbar").html(v),$("#showDown").html(v)}():function(){console.log(a+": "+T);var t=e(a,T);if(void 0!==P&&clearInterval(P),L=Math.round(360*t)+1,document.getElementById("showPing").innerHTML=b,document.getElementById("showDown").innerHTML=v,document.getElementById("showUp").innerHTML=h,"DOWN"===a){S>1&&(S=1),E=Math.round(360*S);var r=d+"speedtest/download-icon.png";k.src!==r&&(k.src=r)}else if("UP"===a){p>1&&(p=1),E=Math.round(360*p);var n=d+"speedtest/upload-icon.png";k.src!==n&&(k.src=n)}I=Math.max(1,L-m),P=setInterval(s,500/I)}(),"END"!==a&&"ERROR"!==a&&"ABORTED"!==a?w=setTimeout(n,250):"ERROR"===a||"ABORTED"===a||"END"===a&&i()}function o(t){switch(null!==U&&(U.stop(),U=null),t){case TestState.LOCATE:B.innerHTML=Lang.getString("Locating");var e={lines:7,length:0,width:3,radius:2,trail:50,speed:1.2,color:"#002D45"};U=new Spinner(e).spin(C);break;case TestState.INIT:case TestState.INIT_DOWN:B.innerHTML=Lang.getString("Initializing");break;case TestState.WAIT:B.innerHTML=Lang.getString("WaitForSlot");break;case TestState.INIT_UP:B.innerHTML=Lang.getString("Init_Upload");break;case TestState.PING:B.innerHTML=Lang.getString("Ping");break;case TestState.DOWN:B.innerHTML=Lang.getString("Download");break;case TestState.UP:B.innerHTML=Lang.getString("Upload");break;case TestState.QOS_TEST_RUNNING:l<0&&(l=(new Date).getTime());var a=(new Date).getTime(),r=Math.min(1,(a-l)/g);B.innerHTML=Lang.getString("QosTest")+" ("+Math.round(100*r)+"&nbsp;%)";break;case TestState.QOS_END:case TestState.SPEEDTEST_END:if(null!==c.getNdtStatus()&&"RUNNING"===c.getNdtStatus().toString()){var n=c.getNdtProgress();B.innerHTML=Lang.getString("NDT")+" ("+Math.round(100*n)+"&nbsp;%)"}break;case TestState.END:B.innerHTML=Lang.getString("Finished");break;case TestState.ERROR:B.innerHTML=Lang.getString("Error"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("ErrorOccuredDuringTest")+"</p>"),F!==t&&(show_errorPopup(),F=t);break;case TestState.ABORTED:B.innerHTML=Lang.getString("Aborted"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("PrematureEnd")+"</p>"),show_errorPopup();break;case"JAVAERROR":B.innerHTML=Lang.getString("Aborted"),$("#popuperror").empty(),$("#popuperror").append("<p>"+Lang.getString("AppletCouldNotBeLoaded")+"</p>"),show_errorPopup();break;case TestState.LOCABORTED:B.innerHTML=Lang.getString("Init_applet"),noJava?start_jstest():start_test();break;default:console.log("Unknown test state: "+t)}}function i(){var t="/"+selectedLanguage+"/Verlauf";(preferredTest===TestTypes.Java||getParam("Java"))&&(t+="?Java=True"),t+="#",t+=G,setTimeout(function(){window.location.href=t},2e3)}function s(){m>=L&&clearInterval(P),m<L&&m++,M!==L&&(m=M,M=L),r()}var d="../img/",g=1e4,l=-1,c=void 0,u=!1,p=void 0,S=void 0,T=void 0,h=void 0,v=void 0,b=void 0,m=0,L=0,M=0,E=0,I=0,f="#2E4653",N=void 0,P=void 0,w=void 0,k=void 0,D=void 0,y=void 0,R=null,_=null,O=null,B=null,H=null,U=null,C=null;t.prototype.setRMBTTest=function(t){c=t};var A=null,W=null,x=null,G="";t.prototype.updateInfo=function(t,e,a,r){A=t,W=e,x=a,G=r},t.prototype.setStatus=function(t){o(t)},t.prototype.setLocation=function(t,e){var a=function(t,e,a){var r=n<0?a:e,n=Math.floor(Math.abs(t));return r+" "+n+"&deg; "+(60*(Math.abs(t)-n)).toFixed(3)+"'"},r=document.getElementById("infogeo");t=a(t,Lang.getString("North"),Lang.getString("South")),e="<br />"+a(e,Lang.getString("East"),Lang.getString("West")),r.innerHTML=t+" "+e},t.prototype.startTest=function(){close_errorPopup(),n()};var Q=-1,F=-1;return t}();
"use strict";function RMBTTestConfig(){}function RMBTTestThread(t){var e=log.getLogger("rmbtws"),s={},o=t;return{setState:function(t){this.state=t,e.debug(this.id+": reached state: "+t);var r=this;o.await(function(){if(e.debug(r.id+": all threads reached state: "+t),void 0!==s[t]&&null!==s[t]){(0,s[t])()}else e.info(r.id+": no callback registered for state: "+t)})},onStateEnter:function(t,e){s[t]=e},retriggerState:function(){setState(this.state)},triggerNextState:function(){var t=[TestState.INIT,TestState.INIT_DOWN,TestState.PING,TestState.DOWN,TestState.INIT_UP,TestState.UP,TestState.END];if(this.state!==TestState.END){var s=t[t.indexOf(this.state)+1];e.debug(this.id+": triggered state "+s),this.setState(s)}},id:-1,socket:null,result:new RMBTThreadTestResult}}function RMBTTestResult(){this.pings=[],this.speedItems=[],this.threads=[]}function RMBTThreadTestResult(){this.down=[],this.up=[],this.pings=[]}function RMBTPingResult(){}RMBTTestConfig.prototype.version="0.3",RMBTTestConfig.prototype.language=selectedLanguage,RMBTTestConfig.prototype.uuid="",RMBTTestConfig.prototype.type="DESKTOP",RMBTTestConfig.prototype.version_code="0.3",RMBTTestConfig.prototype.client_version="0.3",RMBTTestConfig.prototype.client_software_version="0.7.0",RMBTTestConfig.prototype.os_version=1,RMBTTestConfig.prototype.platform="RMBTws",RMBTTestConfig.prototype.model="Websocket",RMBTTestConfig.prototype.product="Chrome",RMBTTestConfig.prototype.client="RMBTws",RMBTTestConfig.prototype.timezone="Europe/Vienna",RMBTTestConfig.prototype.controlServerURL=controlProxy+"/"+wspath,RMBTTestConfig.prototype.controlServerRegistrationResource="/testRequest",RMBTTestConfig.prototype.controlServerResultResource="/result",RMBTTestConfig.prototype.controlServerDataCollectorResource="/requestDataCollector",RMBTTestConfig.prototype.pretestDurationMs=2e3,RMBTTestConfig.prototype.savedChunks=4,RMBTTestConfig.prototype.measurementPointsTimespan=40,RMBTTestConfig.prototype.numPings=10,RMBTTestConfig.prototype.downloadThreadsLimitsMbit={0:1,1:3,100:5},RMBTTestConfig.prototype.uploadThreadsLimitsMbit={0:1,30:2,80:3,150:5},RMBTTestConfig.prototype.userServerSelection=void 0!==window.userServerSelection?userServerSelection:0,RMBTTestConfig.prototype.additionalRegistrationParameters={},RMBTTestConfig.prototype.additionalSubmissionParameters={};var RMBTControlServerRegistrationResponse=function(){function t(t){this.client_remote_ip=t.client_remote_ip,this.provider=t.provider,this.test_server_encryption=t.test_server_encryption,this.test_numthreads=t.test_numthreads,this.test_server_name=t.test_server_name,this.test_uuid=t.test_uuid,this.test_id=t.test_id,this.test_token=t.test_token,this.test_server_address=t.test_server_address,this.test_duration=parseInt(t.test_duration),this.result_url=t.result_url,this.test_wait=t.test_wait,this.test_server_port=t.test_server_port}return t.prototype.client_remote_ip,t.prototype.provider,t.prototype.test_server_encryption="",t.prototype.test_numthreads,t.prototype.test_server_name,t.prototype.test_uuid,t.prototype.test_id,t.prototype.test_token,t.prototype.test_server_address,t.prototype.test_duration,t.prototype.result_url,t.prototype.test_wait,t.prototype.test_server_port,t}();RMBTTestResult.prototype.addThread=function(t){this.threads.push(t)},RMBTTestResult.prototype.ip_local=null,RMBTTestResult.prototype.ip_server=null,RMBTTestResult.prototype.port_remote=null,RMBTTestResult.prototype.num_threads=null,RMBTTestResult.prototype.encryption="NONE",RMBTTestResult.prototype.ping_shortest=-1,RMBTTestResult.prototype.ping_median=-1,RMBTTestResult.prototype.client_version=null,RMBTTestResult.prototype.pings=[],RMBTTestResult.prototype.speed_download=-1,RMBTTestResult.prototype.speed_upload=-1,RMBTTestResult.prototype.speedItems=[],RMBTTestResult.prototype.bytes_download=-1,RMBTTestResult.prototype.nsec_download=-1,RMBTTestResult.prototype.bytes_upload=-1,RMBTTestResult.prototype.nsec_upload=-1,RMBTTestResult.prototype.totalDownBytes=-1,RMBTTestResult.prototype.totalUpBytes=-1,RMBTTestResult.prototype.beginTime=-1,RMBTTestResult.prototype.geoLocations=[],RMBTTestResult.calculateOverallSpeedFromMultipleThreads=function(t,e){for(var s=t.length,o=1/0,r=0;r<s;r++){var i=e(t[r]);i.length>0&&i[i.length-1].duration<o&&(o=i[i.length-1].duration)}for(var n=0,p=0;p<s;p++){var a=t[p];if(null!==a&&e(a).length>0){for(var l=e(a).length,T=0;T<e(a).length;T++)if(e(a)[T].duration>=o){l=T;break}var u=void 0;if(l===e(a).length)u=e(a)[e(a).length-1].bytes;else{var d=0===l?0:e(a)[l-1].bytes,R=e(a)[l].bytes,h=R-d,y=0===l?0:e(a)[l-1].duration,_=e(a)[l].duration,g=_-y,c=o-y,M=c/g,B=Math.round(h*M);B<0&&(B=0),u=d+B}n+=u}}return{bytes:n,nsec:o,speed:8*n/(o/1e9)}},RMBTTestResult.prototype.calculateAll=function(){for(var t=0;t<this.threads.length;t++){var e=this.threads[t].down;if(e.length>0)for(var s=0;s<e.length;s++)this.speedItems.push({direction:"download",thread:t,time:e[s].duration,bytes:e[s].bytes})}var o=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.down});this.speed_download=o.speed/1e3,this.bytes_download=o.bytes,this.nsec_download=o.nsec;for(var r=0;r<this.threads.length;r++){var i=this.threads[r].up;if(i.length>0)for(var n=0;n<i.length;n++)this.speedItems.push({direction:"upload",thread:r,time:i[n].duration,bytes:i[n].bytes})}o=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.up}),this.speed_upload=o.speed/1e3,this.bytes_upload=o.bytes,this.nsec_upload=o.nsec;for(var p=this.threads[0].pings,a=1/0,l=0;l<p.length;l++)this.pings.push({value:p[l].client,value_server:p[l].server,time_ns:p[l].timeNs}),p[l].client<a&&(a=p[l].client);this.ping_shortest=a},RMBTThreadTestResult.prototype.down=null,RMBTThreadTestResult.prototype.up=null,RMBTThreadTestResult.prototype.pings=null,RMBTThreadTestResult.prototype.totalDownBytes=-1,RMBTThreadTestResult.prototype.totalUpBytes=-1,RMBTPingResult.prototype.client=-1,RMBTPingResult.prototype.server=-1,RMBTPingResult.prototype.timeNs=-1;var RMBTError={NOT_SUPPORTED:"WebSockets are not supported",SOCKET_INIT_FAILED:"WebSocket initialization failed",CONNECT_FAILED:"connection to test server failed",SUBMIT_FAILED:"Error during submission of test results",REGISTRATION_FAILED:"Error during test registration"};
"use strict";function nowMs(){return window.performance.now()}function nowNs(){return Math.round(1e6*window.performance.now())}!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),void 0===window.performance&&(window.performance={}),!window.performance.now||void 0===window.performance.now){var n=Date.now();performance.timing&&performance.timing.navigationStart&&(n=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-n}}}();var CyclicBarrier=function(){function n(n){e=n}function o(){var n=t.slice();t=[];for(var o=0;o<e;o++)window.setTimeout(n[o],1)}var e=void 0,t=[];return n.prototype.await=function(n){t.push(n),t.length===e&&o()},n}();Math.median=function(n){n.sort(function(n,o){return n-o});var o=Math.floor(n.length/2);return n.length%2?n[o]:(n[o-1]+n[o])/2},Math.log10=Math.log10||function(n){return Math.log(n)/Math.LN10},self.log=self.log||{debug:function(n){console.log(n)},trace:function(){console.trace()},info:function(n){console.info(n)},warn:function(n){console.warn(n)},error:function(n){console.error(n)},setLevel:function(){},getLogger:function(){return log}},"function"!=typeof Object.assign&&(Object.assign=function(n,o){if(null==n)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(n),t=1;t<arguments.length;t++){var r=arguments[t];if(null!=r)for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}),void 0===document.hidden&&(document.hidden=!1);
//# sourceMappingURL=rmbtws.min.js.map
