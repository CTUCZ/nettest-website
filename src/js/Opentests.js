/* 
 * Script for loading test results from ONE test (only open-data content)
 * Used only by Opentest.html
 */

var color_for_speed_graph = "#59b200"; //or green: #00CC00
var histogramCanvasHeight = 200; //px
var histogramEnabled = true;
var mapEnabled = true;
var histogramClickableThreshold = 20; //at least X entries for a part in the histogram to be clickable

/* Enable or disable lazy loading of more search results
 * as the user scrolls to the bottom of the window */
var enableLazyLoading = true;
var enableAutoRefreshing = true; //automatically load new tests while visiting the site
var autoRefreshingInterval = 15000; //in ms
var resultsLoaded = 400;


/* Standard values for the dropbown-fields in the advanced search */
//var possibleNetworkTypes = ["1xRTT","2G/3G","2G/3G/4G","2G/4G","3G/4G","CDMA","CELLULAR_ANY","CLI","EDGE","EHRPD","EVDO_0","EVDO_A","EVDO_B","GSM","HSDPA","HSPA","HSPA+","HSUPA","IDEN","LAN","LTE","UMTS","WLAN"];
var possibleClientVersions = [[["0.3"],["0.3"]],[["0.8"],["0.8.*"]],[["0.9"],["0.9.*"]],["1.0","1.0"],[["1.1"],["1.1"]],[["1.2"],["1.2*"]],[["1.3"],["1.3*"]],[["1.4"],["1.4*"]],[["1.5"],["1.5*"]],[["2.0"],["2.0*"]]];
var possibleConnectionTypes = ["2G","2G/3G","2G/3G/4G","2G/4G","3G","3G/4G","4G","CLI","LAN","MOBILE","WLAN"];

$(document).ready(function() {
    
    //load filter from address bar
    var filter;
    if (window.location.href.indexOf('?')>0) {
        filter = window.location.href.substr(window.location.href.indexOf('?'));
        //remove hashes
        if (filter.indexOf("#") > 0) {
            filter = filter.substr(0,filter.indexOf("#"));
        }
        
        if (developerCode > 0) {
            filter += "&developer_code=" + developerCode;
        }
    } else {
        filter = "";
        if (developerCode > 0) {
            filter += "?developer_code=" + developerCode;
        }
    }
    
    loadTestsByFilter(filter); //start loading tests async
    if (histogramEnabled) {
        $("#histograms-accordion").one("click",function(){
            loadHistograms(filter, "download"); //start loading histograms
        });
    }
    if (mapEnabled)
        initializeMap();
    loadPossibleFilterValues(); //load values for filter-dropdowns
    loadParametersFromUrl(); //load selected filters for search in the search-form
    
    
    $(window).resize(function() {
        adjustTablesToWindowSize();
    });
});


var currentlyDisplayedResults = 0; //incremented with each call when lazy-loading is enabled
var currentFirstTestUUID = null;
function loadTestsByFilter(filter) {
    //this should take longer => inform the user that the system is working
    $('#spinner').spin('modal');
    
    //add maxresults to the filter
    if (filter.length > 0) {
        if (filter.indexOf("max_results") === -1) {
            filter += "&max_results=" + resultsLoaded;
        }
    }
    else {
        filter = "?max_results=" + resultsLoaded;
    }
    
    //add download classification
    filter += "&additional_info[]=download_classification";
    
    $.ajax({
        url: statisticProxy + "/" + statisticpath + "/opentests/search" + filter,
        type: 'GET',
        dataType: 'json',
        cache: false,
        statusCode: {
            404: function(data) {
                //remove the spinner
                //by calling the same function that invoked it
                $('#spinner').spin('modal');
            },
            400: function(data) {
                //remove the spinner
                //by calling the same function that invoked it
                $('#spinner').spin('modal');
                alert("invalid parameter");
            }
        },
        success: function(data) {
            //for each opentest in the "openTests"-table
            var tests = data.results;
            for (var i = 0; i < tests.length; i++) {
                 $("#verlauf").append(getOpenDataRow(tests[i]));
                 
                 //add to map
                 if (mapEnabled) {
                     addTestToMap(tests[i]);
                 }
            }
            if (mapEnabled) {
                panMapToShowTests();
            }
            
            
            //fill #results
            currentlyDisplayedResults += data.results.length;
            $("#number-of-results").html(currentlyDisplayedResults + "");
            
            //link table rows
            $('#verlauf tr').click( function() {
                window.location = $(this).find('a').first().attr('href');
            });
            
            //make link to the next page
            if (data.next_cursor !== null) {
                var href=window.location.href;
                var newcursor = "cursor=" + data.next_cursor;
                if (href.indexOf("cursor")>0)
                    href= href.replace(/cursor=[0-9]*/g,newcursor)
                else {
                    if (href.indexOf("?") > 0)
                        href=href + "&" + newcursor;
                    else
                        href=href + "?" + newcursor;
                }

                //fill in the link
                $("#next-result-page").attr("href",href);

                $("#number-of-results").prepend("> ");
            } else {
                //remove the page-link
                $("#next-result-page").remove();
            }
            
            
            //remove the spinner
            //by calling the same function that invoked it
            $('#spinner').spin('modal');
            
            //if there are no results => inform the user
            if (data.results.length === 0) {
                $("#verlauf").hide();
            }

            //register function for lazy-loading new tests
            var scrollTarget = (developerCode > 0) ? window : "div.scroller";
            var innerScrollTarget = (developerCode > 0) ? document : "div.scroller-inner";
            $(scrollTarget).scroll(function() {
                //allow for some error margin (since WebKit uses float values on HiDPI monitors)
                if (Math.abs($(scrollTarget).scrollTop() - ($(innerScrollTarget).height() - $(scrollTarget).height())) < 5) {
                    //unbind (only execute once)
                    $(scrollTarget).unbind('scroll');
                    
                    //only if there are more results
                    if (data.next_cursor === null || !enableLazyLoading) 
                        return;
                    
                    //set cursor
                    filter = setURLParameter("cursor", data.next_cursor, filter);
                    loadTestsByFilter(filter);
                }
            });

            //automatically load new tests as they arrive
            if (enableAutoRefreshing && getURLParameter("sort_order") === "null") {
                //only execute on first page load
                if (currentFirstTestUUID === null) {
                    currentFirstTestUUID = data.results[0].open_test_uuid;
                    var automaticReload = function() {
                        var originalFilter = filter; //remember original filter

                        window.setInterval(function () {
                            $.ajax({
                                url: statisticProxy + "/" + statisticpath + "/opentests/search" + originalFilter,
                                type: 'GET',
                                dataType: 'json',
                                cache: false,
                                success: function (data) {
                                    if (data.results.length > 0) {
                                        var newResults = 0;
                                        $.each(data.results, function (i, test) {
                                            //if we reached the current test -> break!
                                            if (test.open_test_uuid === currentFirstTestUUID) {
                                                return false;
                                            }
                                            $("#verlauf").prepend(getOpenDataRow(test));
                                            newResults++;
                                        });
                                        currentFirstTestUUID = data.results[0].open_test_uuid;

                                        //fill #results
                                        currentlyDisplayedResults += newResults;
                                        $("#number-of-results").html(currentlyDisplayedResults + "");
                                    }
                                }
                            });
                        }, autoRefreshingInterval);
                    }();
                }
            }
            
            adjustTablesToWindowSize();
            
            //remove min-height that prevented user browser from scrolling to top
            //when handling back button (#250)
            $(".testdata-content").removeClass("initial-placeholder");
        }
    });
}


function loadHistograms(filter, measurement) {
    var speedFormatter = function(val, min, max) {
        if (val === null) {
            return "";
        }
        else {
            //calculate how many positions are needed
            var step = (max - min) / 1000 / 12;
            var positions = Math.ceil(Math.abs(Math.log(step) / Math.LN10));

            //if at least 1 mbit difference -> use two significant digits
            if (step > 1) {
                if (val < 1000)
                    return (val / 1000).formatNumber(2);
                else if (val < 10000)
                    return (val / 1000).formatNumber(1);
                else
                    return (val / 1000).formatNumber(0);
            }
            else {
                return (val / 1000).formatNumber(positions);
            }
        }
    }
    
    $('#spinner').spin('modal');
    
    $.ajax({
        url: statisticProxy + "/" + statisticpath + "/opentests/histogram" + filter + ((filter.length > 0)?"&":"?") + "measurement=" + measurement,
        type: 'GET',
        dataType: 'json',
        statusCode: {
            404: function(data) {
                //remove the spinner
                //by calling the same function that invoked it
                //$('#spinner').spin('modal');
            },
            400: function(data) {
                //remove the spinner
                //by calling the same function that invoked it
                //$('#spinner').spin('modal');
                alert("invalid parameter");
            }
        },
        success: function(data) {
            $('#spinner').spin('modal');
    
            //for each opentest in the "openTests"-table

            if (measurement === "download") {
                bindTabs(filter);
                loadHistogram("download_kbit", data.download_kbit, speedFormatter);
            }
            else if (measurement === "upload") {
                loadHistogram("upload_kbit", data.upload_kbit, speedFormatter);
            }
            else if (measurement === "ping") {
                loadHistogram("ping_ms", data.ping_ms);
            }
        }
    });
}

function loadHistogram(identifier, data, formatter) {
    //bars
    var bars = [];
    var max = data[data.length-2].upper_bound;
    var min = data[0].lower_bound;
    
    if (formatter === undefined) {
        formatter = function(val, min, max) {
            if (val === null) {
                return "";
            }
            //calculate how many positions are needed
            //var step = (max - min) / 1000 / 12;
            //var positions = Math.ceil(Math.abs(Math.log(step) / Math.LN10));
            return val;
        };
    }
    
    for (var i=0;i<data.length;i++) { 
        //add to array
        bars.push([i,data[i].results]);
    }

    var placeholder = $("#histograms .histogram-" + identifier + "-graph");
    placeholder.empty();
    //set width for flot
    placeholder.css("width", $(".tab-content.tab-selected").width() + "px");
    placeholder.css("height", histogramCanvasHeight + "px");

    //draw the plot
    var plot = $.plot(placeholder, [{
            data: bars,
            color: color_for_speed_graph}],
    {
        grid: {hoverable: true, clickable: true},
        bars: {show: true, barWidth: 1},
        xaxis: {tickSize: 1,
            tickFormatter: function(v, axis) {
                //normal point
                if (data[v] !== undefined) {
                    return formatter(data[v].lower_bound, min, max);
                }
                else {
                    return formatter(data[v-1].upper_bound, min, max);
                }
            }}
    });

    placeholder = $("#histograms .histogram-" + identifier + "-graph");
    $("#histograms .histogram-" + identifier + "-graph").bind("plothover", function(event, pos, item) {
        if (item !== null) {
            plot.unhighlight();
            plot.highlight(item.series, item.datapoint);
            
            //clickable if at least one result
            if (data[item.dataIndex].results > histogramClickableThreshold) {
                document.body.style.cursor = 'pointer';
            }
        }
        else {
            document.body.style.cursor = 'default';
            plot.unhighlight();
        }
    });

    placeholder.bind("plotclick", function(event, pos, item) {

        if (item !== null) {
            plot.unhighlight();
            plot.highlight(item.series, item.datapoint);
            
            
            var lower = data[item.dataIndex].lower_bound;
            var upper = data[item.dataIndex].upper_bound;
            //get upper and lower bound
            if (identifier === 'download_kbit' || identifier === 'upload_kbit') {
                lower=lower/1000;
                upper=upper/1000;
            }
            
            //get them in the form fields
            $("#" + identifier).val(lower);
            //if upper exists
            if (upper !== null && upper !== 0) {
                $("#" + identifier + "_upper").val(upper);
            } else {
                //else, use lower bound * 6 (since 12 classes)
                $("#" + identifier + "_upper").val(lower*6);
            }
            
            //clickable if at least one result
            if (data[item.dataIndex].results > histogramClickableThreshold) {
                setFilters();
            }
        } else {
            plot.unhighlight();
        }
    });
    
}

function bindTabs(filter) {      
        var showTab = function() {
                //alert(1);
                $(".tabs-content .tab-content").hide();
                $(".tabs-content .tab-content.tab-selected").show();
                //alert(2);
        };
        showTab();
        
        $(".tabs-header a").click(function() {
                var id = $(this).attr("href"); //e.g. #histogram-download
                
                //load content if not yet loaded
                if ($(id).hasClass("not-loaded")) {
                    $(id).removeClass("not-loaded")
                    loadHistograms(filter,id.substring(11));
                }
                
                $(".tabs-header li").removeClass("tab-selected");
                $(".tabs-content .tab-content").removeClass("tab-selected");
                $(id).addClass("tab-selected"); 
                $(this).parent().addClass("tab-selected");
                showTab();
                
                return false;
        });
}

var map, vectorSource, vectorLayer;
function initializeMap() {
    var bases = new Array();
    bases.push(
            new ol.layer.Tile({
                visible: true,
                preload: Infinity,
                title: 'Bing Maps',
                type: 'base',
                source: new ol.source.BingMaps({
                    key: bing_api_key,
                    imagerySet: 'Road'
                            // use maxZoom 19 to see stretched tiles instead of the BingMaps
                            // "no photos at this zoom level" tiles
                            // maxZoom: 19
                })
            }));
    
    vectorSource = new ol.source.Vector({});
    var currentFeatures = [];
    
    var colors = [
        'rgba(128, 128, 128, 0.9)', //undefined - 0
        'rgba(255, 0, 0, 0.9)', //red - 1
        'rgba(255, 255, 0, 0.9)', //yellow - 2
        'rgba(0, 255, 0, 0.9)', //green - 3
        'rgba(0, 153, 0, 0.9)' //dark green - 4
    ];
        
    var stylingFct = function(feature, resolution) {
        return    [new ol.style.Style({
            image: new ol.style.Circle({
                fill: new ol.style.Fill({
                    color: colors[feature.get('result').download_classification]
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(128, 128, 128, 0.9)',
                    width: 1.25
                }),
                radius: 6
            })
        })];
    }
    
    vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: stylingFct
    })
    
    map = new ol.Map({
        layers: bases,
        controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                collapsible: false
            })
        }),
        target: $('#opentests-map-container')[0],
        view: new ol.View({
            center: [0, 0],
            zoom: 2,
            maxZoom : 19
        })
    });

    
    map.addLayer(vectorLayer);

    map.on('click', function (evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
                function (feature, layer) {
                    return feature;
                });
        if (feature) {
            var geometry = feature.getGeometry();
            var coord = geometry.getCoordinates();
            
            var test = feature.get("result");
            var uuid = test.open_test_uuid;
            
            //Open Popup?
            window.location = "Opentest?" + uuid;
        } else {
            //$(element).popover('destroy');
            //remove popup
        }
    });
    
    // change mouse cursor when over marker
    map.on('pointermove', function (e) {
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.hasFeatureAtPixel(pixel);
        map.getTarget().style.cursor = hit ? 'pointer' : '';
    });
    
    //fit to Austrian border initially
    var textent = [1252344.27125, 5846515.498922221, 1907596.397450879, 6284446.2299491335];
    map.getView().fit(textent, map.getSize());
    
    //load test results
    var currentFirstTestUUID = null;
    
    window.setTimeout(function() {
        map.updateSize();
    },1)
    $(window).resize(function() {
        map.updateSize();
    })
    $(".menu-trigger #trigger").click(function() {
        //resize whenever mobile menu is opened/closed
        window.setTimeout(function() {
            map.updateSize();
        },10);
        window.setTimeout(function() {
            map.updateSize();
        },200); 
        window.setTimeout(function() {
            map.updateSize();
        },500); 
    })
}

function addTestToMap(test) {
    var convertLongLatToOpenLayersPoint = function (long, lat) {
        return ol.proj.transform([long, lat],
                'EPSG:4326', 'EPSG:3857');
    }
    
    if (test.long === null) {
        return;
    }

    var coords = convertLongLatToOpenLayersPoint(test.long, test.lat);
    var feature = new ol.Feature({
        geometry: new ol.geom.Point(coords),
        result: test
    });
    vectorSource.addFeature(feature);
}

function panMapToShowTests() {
    var extent = vectorLayer.getSource().getExtent();
    map.getView().fit(extent, map.getSize());
}

/**
 * Sorts all results by the given criteria; 
 * alternates between ascending and descending order
 * called by onclick-events in the result table columns
 * @param {String} criteria the allowed criteria (see control-server specification)
 * @returns {String} the new search string
 */ 
function sortResultsBy(criteria) { 
    var order; 
    if (getURLParameter("sort_order") !== "null") {
        order = getURLParameter("sort_order");
        if (order === "asc")
            order = "desc"
        else
            order = "asc"
    } 
    else {
        order = "desc";
    }
    
    //cache search-url
    var search = location.search; 
    
    //remove cursor
    search = setURLParameter("cursor","",search);
    search = search.replace("?cursor=","");
    search = search.replace("&cursor=","");
    
    search = setURLParameter("sort_by",criteria,search);
    search = setURLParameter("sort_order",order,search);
    location.search = search;
}

/**
 * Gets the value for a GET-Parameter
 * @param {String} name name of the parameter
 * @param {String} searchUrl optional, the url
 * @returns {String} the value or "null" (as string)
 */
//https://gist.github.com/MarkVaughn/2096943
function getURLParameter(name, searchUrl) {
    if (searchUrl === undefined) {
        searchUrl = location.search;
    }
    name = name.replace("[",".");
    name = name.replace("]",".");
    var ret= decodeURIComponent(
            (RegExp('[?|&]' + name + '=' + '(.+?)(&|$)').exec(searchUrl) || [null, null])[1]
            );
    return ret;
}

/**
 * Sets the value for a GET-Parameter
 * @param {String} name : name of the parameter
 * @param {type} value : value of the parameter
 * @param {type} searchUrl : optional, the url
 * @returns {String}: the resulting url
 */
//https://gist.github.com/MarkVaughn/2096943
function setURLParameter(name, value, searchUrl) {
    if (searchUrl === undefined) {
        searchUrl = location.search;
    }
    var search;
    if (getURLParameter(name,searchUrl) !== "null") {
        search = searchUrl.replace(new RegExp('([?|&]' + name + '=)' + '(.+?)(&|$)'), "$1" + encodeURIComponent(value) + "$3");
    } else if (searchUrl.length) {
        search = searchUrl + '&' + name + '=' + encodeURIComponent(value);
    } else {
        search = '?' + name + '=' + encodeURIComponent(value);
    }
    return search;
    //History.pushState({state: History.getStateId() + 1}, document.title, search);
}

/**
 * Sets possible values for the longer < select>-Fields
 */
function loadPossibleFilterValues() {
    var html = "";
    for (var i=0;i<possibleClientVersions.length;i++) {
        html += "<option value='" + possibleClientVersions[i][1] + "'>" + possibleClientVersions[i][0] + "</option>";
    }
    $("#client_version").append(html);
    
    html = "";
    for (var i=0;i<possibleConnectionTypes.length;i++) {
        html += "<option>" + possibleConnectionTypes[i] + "</option>";
    }
    $("#cat_technology").append(html);
    
    /* html = "";
    for (var i=0;i<possibleNetworkTypes.length;i++) {
        html += "<option>" + possibleNetworkTypes[i] + "</option>";
    }
    $("#network_type").append(html); */
    
    html = "";
    var possibleSimCountries = Lang.getString('countries');
    $.each(possibleSimCountries,function(key,value) {
        html += "<option value='" + key + "'>" + value + "</option>";
    });

    $("#sim_country").append(html);
    $("#network_country").append(html);
    $("#country_geoip").append(html);
    
    html = "";
    var date = new Date();
    for (var i=2012;i<=date.getFullYear();i++) {
        html += "<option value='" + i + "'>" + i + "</option>";
    }
    $("#time_year").append(html);
}

/**
 * Sets the value from the input element given in "from" as
 * standard value in the input element with the same is as
 * "from" appended with "_upper"
 * @param {DOMElement} from
 */
function copyValueToUpper(from) {
    var id = $(from).attr("id");
    //if ($("#" + id + "_upper").val() === "") {
        $("#" + id + "_upper").attr("placeholder",$(from).val());
    //}
}

/**
 * Sets the new search filters to a new search url and loads the resulting document
 */
function setFilters() {
    var newSearchUrl = "";
    $("#advanced-search input, #advanced-search select").each(function() {
       var id = $(this).attr("id");
       var val = $(this).val();
       
       //_upper-fields are processed along with the lower field
       if ((id.indexOf("_upper") > 0) || id.indexOf("time") >= 0 || val === "" || val === 0 || val === "select" || val === null)
           return; //=continue
       
       //multiply download/upload with 1000
       if (id.indexOf("download") >= 0|| id.indexOf("upload") >= 0)
            val = Math.round(val*1000);
       
           
       
       //if there is an upper-field: special handling
       if ($("#advanced-search #" + id + "_upper").length > 0) {
           var upper = "#" + id + "_upper";
           var upperVal = $(upper).val();
           //multiply download/upload with 1000
           if (id.indexOf("download") >= 0|| id.indexOf("upload") >= 0) 
                upperVal = upperVal*1000;
                
           //if its the same value or the second field is empty => no array
           if (upperVal === "" || upperVal === 0 
                || upperVal === val) {
                newSearchUrl = setURLParameter(id,val,newSearchUrl);
           } 
           else {
                //set upper and lower   
                newSearchUrl = setURLParameter(id + "[]",">" + val + "amp" + id + "brackets<" + upperVal,newSearchUrl);
                newSearchUrl = newSearchUrl.replace("amp","&");
                newSearchUrl = newSearchUrl.replace("brackets","[]=");
           }    
       } else {
           //just set the parameter
           newSearchUrl = setURLParameter(id,val,newSearchUrl);
            
       }
    });
    
    //set time if there is any
    if (($("#time_day").val() !== "select") && ($("#time_day").val() !== null) &&
            $("#time_month").val() !== "select" &&
            ($("#time_year").val() !== "select")) {
        
        var beginDate = new Date($("#time_year").val(),parseInt($("#time_month").val())-1,$("#time_day").val(),0,0,0,0);
        var endDate = new Date($("#time_year").val(),parseInt($("#time_month").val())-1,$("#time_day").val(),23,59,59,0);
        var dateStringBegin = beginDate.getUTCFullYear() + "-" + pad(beginDate.getUTCMonth()+1,2) + "-" + pad(beginDate.getUTCDate(),2)
          + " " + pad(beginDate.getUTCHours(),2) + ":" + pad(beginDate.getUTCMinutes(),2)+ ":" + pad(beginDate.getUTCSeconds(),2) ;
        var dateStringEnd = endDate.getUTCFullYear() + "-" + pad(endDate.getUTCMonth()+1,2) + "-" + pad(endDate.getUTCDate(),2)
          + " " + pad(endDate.getUTCHours(),2) + ":" + pad(endDate.getUTCMinutes(),2) + ":" + pad(endDate.getUTCSeconds(),2);
        newSearchUrl = setURLParameter("time[]",">" + dateStringBegin + "amp" + "timebrackets<" + dateStringEnd,newSearchUrl);
        newSearchUrl = newSearchUrl.replace("amp","&");
        newSearchUrl = newSearchUrl.replace("brackets","[]=");
    }
    
    location.search = newSearchUrl;
}

/**
 * Extracts all applied filters from the url and
 * inserts them in the search-form so the user
 * can see, if the results are filtered
 */
function loadParametersFromUrl() {
    var searchUrl = location.search;
    var filters = 0;
    
    //iterate for every available field rather than for every
    //get parameter (because there are no fields for "cursor", "lat", etc.
    $("#advanced-search input, #advanced-search select").each(function() {
       var id = $(this).attr("id");
       if (id.indexOf("_upper") === -1) {
           $(this).val("1");
           $(this).val("");
           $("#" + id + "_upper").val("1");
           $("#" + id + "_upper").val("");
       }
       
       var val = getURLParameter(id,searchUrl);
       var upperVal = "";
       if (val === "null") {
           val = getURLParameter(id + "..",searchUrl); //since getURLParameter uses RegEx, . for brackets
           
           //also get the upper value
           if (val !== "null") {
               upperVal = getURLParameter(id + "..", searchUrl.substr(searchUrl.indexOf(id) +1));
           }
       }
       
       //no parameter set for that specific field
       if (val === "null")
           return; //=continue
       
       for (i=0;i<2;i++) {
           if (i===1) {
               val = upperVal;
           }
           if (val === "null" || val === "" || val === 0) {
               continue;
           }
       
            //divide download/upload by 1000
            if (val.indexOf(">") === 0) {
                val = val.substr(1);
                if (id.indexOf("download") >= 0|| id.indexOf("upload") >= 0) 
                     val = val/1000;
                $(this).val(val);
            }
            else if (val.indexOf("<") === 0) {
                val = val.substr(1);
                if (id.indexOf("download") >= 0|| id.indexOf("upload") >= 0) 
                     val = val/1000;
                $("#" + id + "_upper").val(val);
            } 
            else {
                if (id.indexOf("download") >= 0|| id.indexOf("upload") >= 0) 
                     val = val/1000;
                $(this).val(val);
            };
       }
       filters++;
    });
    
    //if time is set => get filters
    var val = getURLParameter("time..",searchUrl); //again, .. instead of brackets for regex
    if (val !== "null") {
        var date;
        val = val.substr(1); //cut comperator
          
        //if its java-date => get from there
        if (val.indexOf(":") === -1)
            date = new Date(parseInt(val));
        else {
            val = formatOpenDataDateToLocalTime(val); //convert to local time from utc
            date = new Date(val.substr(0,4),parseInt(val.substr(5,2)-1),val.substr(8,2));
        }
        
        $("#time_year").val(date.getFullYear() + "");
        $("#time_month").val(pad((date.getMonth()+1),2));
        setDaysFor(date.getMonth()+1);
        $("#time_day").val(pad(date.getDate(),2));
        filters++;
    }
    
    //display filter count to the user
    if (filters>0)
        $("#advanced-search-filter-count").html("(" + filters + ")");
}

/**
 * Gets the day count for a specific month in #time_day
 * taking no account for leap years
 * called by onchange-events in the month-dropdowns
 * @param {int} month
 */
function setDaysFor(month) {
    var selected = $("#time_day").val();
    month = parseInt(month);
    var maxdays = 30;
    switch (month) {
        case 1:
        case 3:
        case 5:
        case 7:
        case 8:
        case 10:             
        case 12:             
            maxdays = 31;
            break;
        case 2:
            maxdays = 28; //no tests in leap years for now
            break;
    }
    $("#time_day").empty();
    $("#time_day").append("<option value='select'>--</option>");
    for (var i=1;i<=maxdays;i++) {
        $("#time_day").append("<option value='" + pad(i,2) + "'>" + i + "</option>");
    }
    
    $("#time_day").val(selected); //restore selected day if possible
}

/**
 * removes the "signal strength"-column if there is to less space on the device
 */
function adjustTablesToWindowSize() {
    var device_width = $(".main-article").width();
    //decide which table to display as follows:
    //if device-width is large enough => display normal table
    //if device-width is too small for that but large enough for short provider names => display table_short
    //else: display table with captions inbetween
    $("#verlauf td.test-network-signal").show();
    $("#verlauf th.test-network-signal").show();
    if (device_width < $("#verlauf").width()) {
        $("#verlauf td.test-network-signal").hide();
        $("#verlauf th.test-network-signal").hide();
    } 
    //alert(device_width + " -- " + $("#verlauf").width());
}